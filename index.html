<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKF HR - Smart Resume Screening Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .screening-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #4a5568;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section h3 i {
            color: #667eea;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
            position: relative;
            overflow: hidden;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }

        .file-upload-area p {
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .file-upload-area small {
            color: #718096;
            font-size: 0.9rem;
        }

        .file-upload-area input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .results-section {
            margin-top: 40px;
            display: none;
        }

        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f7fafc;
        }

        .candidate-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
        }

        .match-score {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .candidate-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 500;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1rem;
            color: #2d3748;
            font-weight: 600;
        }

        .skills-section, .concerns-section {
            margin-top: 20px;
        }

        .skills-section h4, .concerns-section h4 {
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .skills-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            background: #edf2f7;
            color: #4a5568;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .concern-tag {
            background: #fed7d7;
            color: #c53030;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .recommendation {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .recommendation h4 {
            color: #2d3748;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .recommendation p {
            color: #4a5568;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c53030;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .screening-form {
                padding: 25px;
            }
            
            .candidate-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
                 <div class="header">
             <h1><i class="fas fa-user-tie"></i> IKF HR</h1>
             <p>Smart Resume Screening Assistant - Professional Candidate Assessment</p>
             <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">AI-powered resume analysis with real data extraction</p>
         </div>

        <div class="screening-form">
            <div class="form-section">
                <h3><i class="fas fa-briefcase"></i> Job Description</h3>
                <div class="file-upload-area" onclick="triggerFileUpload('jobDescriptionFile')">
                    <i class="fas fa-file-alt"></i>
                    <p>Upload Job Description</p>
                    <small>PDF, DOC, DOCX, or TXT files accepted</small>
                    <input type="file" id="jobDescriptionFile" accept=".pdf,.doc,.docx,.txt" onchange="updateJobFileInfo()">
                </div>
                <div id="jobFileInfo" style="margin-top: 10px; font-size: 0.9rem; color: #48bb78;"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-users"></i> Candidate Resumes</h3>
                <div class="file-upload-area" onclick="triggerFileUpload('resumeFiles')">
                    <i class="fas fa-file-upload"></i>
                    <p>Upload Resume(s)</p>
                    <small>Multiple files accepted. PDF, DOC, DOCX, or TXT</small>
                    <input type="file" id="resumeFiles" accept=".pdf,.doc,.docx,.txt" multiple onchange="updateResumeFileInfo()">
                </div>
                <div id="resumeFileInfo" style="margin-top: 10px; font-size: 0.9rem; color: #48bb78;"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startScreening()" id="screeningBtn">
                    <i class="fas fa-search"></i> Start Smart Screening
                </button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
                         <div class="loading" id="loadingSection">
                 <i class="fas fa-spinner"></i>
                 <p>Reading and analyzing resume content...</p>
             </div>
            
            <div id="resultsContent" style="display: none;">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        function triggerFileUpload(inputId) {
            document.getElementById(inputId).click();
        }

        function updateJobFileInfo() {
            const input = document.getElementById('jobDescriptionFile');
            const info = document.getElementById('jobFileInfo');
            if (input.files.length > 0) {
                info.textContent = `Selected: ${input.files[0].name}`;
            }
        }

        function updateResumeFileInfo() {
            const input = document.getElementById('resumeFiles');
            const info = document.getElementById('resumeFileInfo');
            if (input.files.length > 0) {
                const count = input.files.length;
                const names = Array.from(input.files).map(f => f.name).join(', ');
                info.textContent = `Selected ${count} file(s): ${names}`;
            }
        }

        function startScreening() {
            const jobFile = document.getElementById('jobDescriptionFile').files[0];
            const resumeFiles = document.getElementById('resumeFiles').files;

            if (!jobFile) {
                alert('Please upload a job description first.');
                return;
            }

            if (resumeFiles.length === 0) {
                alert('Please upload at least one resume.');
                return;
            }

            console.log('Starting screening with:', { jobFile: jobFile.name, resumeCount: resumeFiles.length });

            // Show results section and loading
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('screeningBtn').disabled = true;

            console.log('Results section displayed:', document.getElementById('resultsSection').style.display);

            // Simulate AI processing (replace with actual backend call)
            setTimeout(() => {
                console.log('Timeout completed, calling processScreeningResults');
                processScreeningResults(jobFile, resumeFiles);
            }, 2000);
        }

        async function processScreeningResults(jobFile, resumeFiles) {
            console.log('processScreeningResults called with:', { jobFile: jobFile.name, resumeCount: resumeFiles.length });
            
            try {
                // Hide loading, show results
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('resultsContent').style.display = 'block';
                document.getElementById('screeningBtn').disabled = false;

                console.log('Loading hidden, results content shown');

                // Parse job description first
                const jobDescription = await parseResumeContent(jobFile);
                console.log('Job description parsed, length:', jobDescription.length);
                
                // Store job description globally
                window.currentJobDescription = jobDescription;
                
                // Actually parse and analyze the resume files with job description
                const results = await parseResumeFiles(resumeFiles, jobDescription);
                console.log('Resume parsing completed, results:', results);
                
                displayResults(results);
                console.log('Results displayed');
                
            } catch (error) {
                console.error('Error in processScreeningResults:', error);
                alert('Error processing screening results: ' + error.message);
            }
        }

        async function parseResumeFiles(resumeFiles, jobDescription = '') {
            const results = [];
            
            for (let i = 0; i < resumeFiles.length; i++) {
                const file = resumeFiles[i];
                const candidateName = file.name.replace(/\.[^/.]+$/, ''); // Remove file extension
                
                try {
                    // Parse the actual resume file content
                    const resumeData = await parseResumeContent(file);
                    
                    // Ensure all extracted data is properly initialized
                    const extractedData = {
                        name: candidateName,
                        fileName: file.name,
                        gender: extractGender(resumeData) || 'Not Mentioned',
                        location: extractLocation(resumeData) || 'Not Mentioned',
                        profileStability: analyzeProfileStability(resumeData) || 'Not Mentioned',
                        keySkills: extractSkills(resumeData) || [],
                        availability: extractAvailability(resumeData) || 'Not Mentioned',
                        currentCTC: extractCurrentCTC(resumeData) || 'Not Mentioned',
                        expectedCTC: extractExpectedCTC(resumeData) || 'Not Mentioned',
                        concerns: identifyConcerns(resumeData) || []
                    };
                    
                    // Calculate match score with job description comparison
                    extractedData.matchScore = calculateMatchScore(extractedData, jobDescription);
                    
                    // Generate recommendation
                    extractedData.recommendation = generateRecommendation(extractedData);
                    
                    results.push(extractedData);
                    
                } catch (error) {
                    console.error(`Error processing file ${file.name}:`, error);
                    
                    // Add fallback data for failed parsing
                    results.push({
                        name: candidateName,
                        fileName: file.name,
                        matchScore: 0,
                        gender: 'Error in parsing',
                        location: 'Error in parsing',
                        profileStability: 'Error in parsing',
                        keySkills: [],
                        availability: 'Error in parsing',
                        currentCTC: 'Error in parsing',
                        expectedCTC: 'Error in parsing',
                        concerns: ['File parsing failed'],
                        recommendation: 'Analysis failed - please check file format'
                    });
                }
            }
            
            return results;
        }

        function displayResults(results) {
            console.log('displayResults called with:', results);
            
            const content = document.getElementById('resultsContent');
            console.log('Results content element:', content);
            
            if (!content) {
                console.error('resultsContent element not found!');
                return;
            }
            
            // Store results globally for other functions to use
            window.currentResults = results;
            
            // Sort candidates by match score (highest first)
            const sortedResults = [...results].sort((a, b) => b.matchScore - a.matchScore);
            
            // Categorize candidates
            const strongCandidates = sortedResults.filter(c => c.matchScore >= 80);
            const goodCandidates = sortedResults.filter(c => c.matchScore >= 70 && c.matchScore < 80);
            const moderateCandidates = sortedResults.filter(c => c.matchScore >= 60 && c.matchScore < 70);
            const weakCandidates = sortedResults.filter(c => c.matchScore < 60);
            
            let html = `
                <h2 style="color: #2d3748; margin-bottom: 30px; text-align: center;">Smart Screening Results</h2>
                
                <!-- Summary Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #38a169; margin-bottom: 10px;">🚀 Strong Matches</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #38a169;">${strongCandidates.length}</div>
                        <small style="color: #718096;">80%+ Match</small>
                    </div>
                    <div style="background: #fef5e7; border: 2px solid #ed8936; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #dd6b20; margin-bottom: 10px;">✅ Good Matches</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #dd6b20;">${goodCandidates.length}</div>
                        <small style="color: #718096;">70-79% Match</small>
                    </div>
                    <div style="background: #fef8e7; border: 2px solid #ecc94b; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #d69e2e; margin-bottom: 10px;">🟡 Moderate</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #d69e2e;">${moderateCandidates.length}</div>
                        <small style="color: #718096;">60-69% Match</small>
                    </div>
                    <div style="background: #fed7d7; border: 2px solid #f56565; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #e53e3e; margin-bottom: 10px;">⚠️ Needs Review</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #e53e3e;">${weakCandidates.length}</div>
                        <small style="color: #718096;">< 60% Match</small>
                    </div>
                </div>
                
                <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #4a5568; margin-bottom: 15px; text-align: center;">📋 Resume Analysis Summary</h3>
                    <p style="color: #718096; line-height: 1.6; text-align: center; margin-bottom: 20px;">
                        <strong>${results.length} resume file(s)</strong> have been analyzed using AI-powered screening.<br>
                        The system has extracted real candidate information and compared it against the job description.<br>
                        <em>All data shown is extracted directly from resume content with intelligent scoring.</em>
                    </p>
                    
                    <!-- Smart Search and Filters -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Search Candidates:</label>
                            <input type="text" id="candidateSearch" placeholder="Search by name, skills, location..." 
                                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;"
                                   onkeyup="filterCandidates()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Filter by Match Score:</label>
                            <select id="scoreFilter" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" onchange="filterCandidates()">
                                <option value="">All Scores</option>
                                <option value="80">80%+ (Strong)</option>
                                <option value="70">70%+ (Good)</option>
                                <option value="60">60%+ (Moderate)</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Filter by Location:</label>
                            <select id="locationFilter" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" onchange="filterCandidates()">
                                <option value="">All Locations</option>
                                ${[...new Set(results.map(r => r.location).filter(l => l !== 'Not Mentioned'))].map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Sort By:</label>
                            <select id="sortFilter" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" onchange="filterCandidates()">
                                <option value="score">Match Score (High to Low)</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="experience">Experience (High to Low)</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            if (results.length > 1) {
                // Comparison table for multiple candidates
                html += createComparisonTable(sortedResults);
            }
            
            // Show candidates by category
            if (strongCandidates.length > 0) {
                html += `<h3 style="color: #38a169; margin: 30px 0 20px 0; text-align: center;">🚀 Strong Matches (${strongCandidates.length})</h3>`;
                strongCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            if (goodCandidates.length > 0) {
                html += `<h3 style="color: #dd6b20; margin: 30px 0 20px 0; text-align: center;">✅ Good Matches (${goodCandidates.length})</h3>`;
                goodCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            if (moderateCandidates.length > 0) {
                html += `<h3 style="color: #d69e2e; margin: 30px 0 20px 0; text-align: center;">🟡 Moderate Matches (${moderateCandidates.length})</h3>`;
                moderateCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            if (weakCandidates.length > 0) {
                html += `<h3 style="color: #e53e3e; margin: 30px 0 20px 0; text-align: center;">⚠️ Candidates Needing Review (${weakCandidates.length})</h3>`;
                weakCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            content.innerHTML = html;
        }

        function createComparisonTable(results) {
            let html = `
                <div class="candidate-card" style="margin-bottom: 30px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-table"></i> Candidate Comparison
                    </h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f7fafc;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Candidate</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Match %</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Top Skills</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Concerns</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Recommendation</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            results.forEach(candidate => {
                html += `
                    <tr>
                                                 <td style="padding: 12px; border-bottom: 1px solid #f7fafc; font-weight: 600;">
                             <div>${candidate.name}</div>
                             <div style="font-size: 0.8rem; color: #718096; font-style: italic;">📄 ${candidate.fileName}</div>
                         </td>
                        <td style="padding: 12px; border-bottom: 1px solid #f7fafc; text-align: center;">
                            <span class="match-score" style="font-size: 0.8rem;">${candidate.matchScore}%</span>
                        </td>
                                                 <td style="padding: 12px; border-bottom: 1px solid #f7fafc;">
                             ${candidate.keySkills.length > 0 ? candidate.keySkills.slice(0, 3).map(skill => `<span class="skill-tag">${skill}</span>`).join(' ') : '<span style="color: #718096; font-style: italic;">Not Mentioned</span>'}
                         </td>
                         <td style="padding: 12px; border-bottom: 1px solid #f7fafc;">
                             ${candidate.concerns.length > 0 ? candidate.concerns.map(concern => `<span class="concern-tag">${concern}</span>`).join(' ') : '<span style="color: #718096; font-style: italic;">No Concerns</span>'}
                         </td>
                                                 <td style="padding: 12px; border-bottom: 1px solid #f7fafc; text-align: center; font-size: 0.8rem;">
                             ${candidate.matchScore > 0 ? (candidate.matchScore > 80 ? '✅ Strong' : candidate.matchScore > 70 ? '🟡 Good' : '🟠 Review') : '⏳ Pending'}
                         </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function createCandidateCard(candidate) {
            return `
                <div class="candidate-card">
                                         <div class="candidate-header">
                         <div>
                             <div class="candidate-name">${candidate.name}</div>
                             <div style="font-size: 0.9rem; color: #718096; margin-top: 5px; font-style: italic;">📄 ${candidate.fileName}</div>
                         </div>
                         <div class="match-score">${candidate.matchScore > 0 ? candidate.matchScore + '% Match' : 'Pending Analysis'}</div>
                     </div>
                    
                    <div class="candidate-details">
                        <div class="detail-item">
                            <div class="detail-label">Gender</div>
                            <div class="detail-value">${candidate.gender}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${candidate.location}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Profile Stability</div>
                            <div class="detail-value">${candidate.profileStability}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Availability</div>
                            <div class="detail-value">${candidate.availability}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Current CTC</div>
                            <div class="detail-value">${candidate.currentCTC}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Expected CTC</div>
                            <div class="detail-value">${candidate.expectedCTC}</div>
                        </div>
                    </div>
                    
                                         <div class="skills-section">
                         <h4><i class="fas fa-star"></i> Key Skills (Relevant to JD)</h4>
                         <div class="skills-grid">
                             ${candidate.keySkills.length > 0 ? candidate.keySkills.map(skill => `<span class="skill-tag">${skill}</span>`).join('') : '<span style="color: #718096; font-style: italic; padding: 10px;">No skills information available</span>'}
                         </div>
                     </div>
                     
                     <div class="concerns-section">
                         <h4><i class="fas fa-exclamation-triangle"></i> Areas of Concern</h4>
                         <div class="skills-grid">
                             ${candidate.concerns.length > 0 ? candidate.concerns.map(concern => `<span class="concern-tag">${concern}</span>`).join('') : '<span style="color: #718096; font-style: italic; padding: 10px;">No concerns identified</span>'}
                         </div>
                     </div>
                    
                                         <div class="recommendation">
                         <h4><i class="fas fa-lightbulb"></i> Recruiter's Recommendation</h4>
                         <p><strong>${candidate.recommendation}</strong></p>
                         <p style="margin-top: 10px; font-size: 0.9rem;">
                             ${candidate.matchScore > 0 ? 
                               `Based on ${candidate.matchScore}% match with job requirements. ${candidate.matchScore > 80 ? 'Strong candidate profile with relevant skills and experience.' : candidate.matchScore > 70 ? 'Good potential match, recommend further evaluation.' : 'Moderate match, consider for specific requirements or backup candidate.'}` : 
                               'Resume analysis required. Please upload resume and job description for evaluation.'}
                         </p>
                         
                         <!-- Action Buttons -->
                         <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                             <button onclick="exportCandidateData('${candidate.name}')" style="background: #4299e1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                 <i class="fas fa-download"></i> Export Data
                             </button>
                             <button onclick="scheduleInterview('${candidate.name}')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                 <i class="fas fa-calendar"></i> Schedule Interview
                             </button>
                             <button onclick="addToShortlist('${candidate.name}')" style="background: #ed8936; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                 <i class="fas fa-star"></i> Add to Shortlist
                             </button>
                         </div>
                     </div>
                </div>
            `;
        }

        // Resume parsing functions
        function parseResumeContent(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        
                        // If it's a PDF, try to extract text content
                        if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                            // For PDFs, we'll try to extract readable text
                            const cleanContent = extractPDFText(content);
                            resolve(cleanContent);
                        } else {
                            // For text files, use as is
                            resolve(content);
                        }
                    } catch (error) {
                        console.warn('Error parsing file content:', error);
                        resolve('File content could not be parsed');
                    }
                };
                reader.onerror = () => resolve('File could not be read');
                
                // For PDFs, read as ArrayBuffer to handle binary content
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });
        }

        function extractPDFText(pdfContent) {
            try {
                // Convert ArrayBuffer to string and extract readable text
                const decoder = new TextDecoder('utf-8');
                const content = decoder.decode(pdfContent);
                
                // Remove PDF metadata and extract actual text content
                // Look for text between parentheses and brackets
                const textMatches = content.match(/\(([^)]+)\)/g) || [];
                const bracketMatches = content.match(/\[([^\]]+)\]/g) || [];
                
                // Extract meaningful text content
                let extractedText = '';
                
                // Add text from parentheses
                textMatches.forEach(match => {
                    const text = match.replace(/[()]/g, '').trim();
                    if (text.length > 3 && !text.includes('obj') && !text.includes('R')) {
                        extractedText += text + ' ';
                    }
                });
                
                // Add text from brackets
                bracketMatches.forEach(match => {
                    const text = match.replace(/[\[\]]/g, '').trim();
                    if (text.length > 3 && !text.includes('obj') && !text.includes('R')) {
                        extractedText += text + ' ';
                    }
                });
                
                // If we have extracted text, return it
                if (extractedText.trim().length > 0) {
                    return extractedText.trim();
                }
                
                // Fallback: try to extract any readable text
                const readableText = content
                    .replace(/[^\x20-\x7E\n]/g, ' ') // Remove non-printable characters
                    .replace(/\s+/g, ' ') // Normalize whitespace
                    .trim();
                
                return readableText || 'PDF content could not be extracted';
                
            } catch (error) {
                console.warn('Error extracting PDF text:', error);
                return 'PDF content could not be extracted';
            }
        }

        function extractGender(text) {
            const genderPatterns = {
                male: /\b(male|m|he|him|his|gentleman|guy)\b/i,
                female: /\b(female|f|she|her|hers|lady|woman)\b/i
            };
            
            for (const [gender, pattern] of Object.entries(genderPatterns)) {
                if (pattern.test(text)) {
                    return gender.charAt(0).toUpperCase() + gender.slice(1);
                }
            }
            return 'Not Mentioned';
        }

        function extractLocation(text) {
            // Common city patterns
            const cityPattern = /\b(Mumbai|Delhi|Bangalore|Hyderabad|Chennai|Pune|Kolkata|Ahmedabad|Jaipur|Surat|Lucknow|Kanpur|Nagpur|Indore|Thane|Bhopal|Visakhapatnam|Pimpri|Patna|Vadodara|Ghaziabad|Ludhiana|Agra|Nashik|Ranchi|Faridabad|Meerut|Rajkot|Kalyan|Vasai|Varanasi|Srinagar|Aurangabad|Navi Mumbai|Solapur|Kolhapur|Shimla|Dehradun|Gurgaon|Noida|Greater Noida|Faridabad|Gurugram)\b/i;
            
            const match = text.match(cityPattern);
            if (match) {
                return match[0];
            }
            
            // Look for state patterns
            const statePattern = /\b(Maharashtra|Delhi|Karnataka|Telangana|Tamil Nadu|Uttar Pradesh|West Bengal|Gujarat|Rajasthan|Punjab|Haryana|Bihar|Madhya Pradesh|Andhra Pradesh|Jharkhand|Chhattisgarh|Uttarakhand|Himachal Pradesh|Assam|Odisha|Kerala|Jammu and Kashmir|Manipur|Meghalaya|Nagaland|Tripura|Arunachal Pradesh|Mizoram|Sikkim|Goa)\b/i;
            
            const stateMatch = text.match(statePattern);
            if (stateMatch) {
                return stateMatch[0];
            }
            
            return 'Not Mentioned';
        }

        function analyzeProfileStability(text) {
            // Enhanced profile stability analysis with multiple factors
            const jobPatterns = [
                // Look for job entries with dates
                /\b(20\d{2}|19\d{2})\s*[-–—]\s*(20\d{2}|19\d{2}|present|current|till date|ongoing)\b/gi,
                // Look for duration patterns
                /\b(\d+)\s*(years?|yrs?|months?|mos?)\b/gi,
                // Look for company names with durations
                /\b(?:at|with|worked at|employed at)\s+[A-Z][a-zA-Z\s&]+(?:for|over|duration|period)\s+(\d+)\s*(years?|yrs?|months?|mos?)\b/gi
            ];
            
            const durations = [];
            const jobChanges = [];
            let totalExperience = 0;
            
            // Extract job durations and changes
            for (const pattern of jobPatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    if (match[1]) {
                        const value = parseInt(match[1]);
                        const unit = match[2] ? match[2].toLowerCase() : 'years';
                        
                        if (unit.includes('year') || unit.includes('yr')) {
                            durations.push(value);
                            totalExperience += value;
                        } else if (unit.includes('month') || unit.includes('mo')) {
                            const yearValue = value / 12;
                            durations.push(yearValue);
                            totalExperience += yearValue;
                        }
                    }
                }
            }
            
            // Count job changes from company names and dates
            const companyPattern = /\b(?:at|with|worked at|employed at|joined|started)\s+([A-Z][a-zA-Z\s&]+(?:Inc|Ltd|Corp|Company|Tech|Solutions|Systems|Services|Consulting|Group|LLC|Pvt|Private|Limited))\b/gi;
            const companies = new Set();
            let companyMatch;
            while ((companyMatch = companyPattern.exec(text)) !== null) {
                companies.add(companyMatch[1].trim());
            }
            
            // Calculate stability score
            let stabilityScore = 0;
            let stabilityLabel = 'Not Mentioned';
            
            if (durations.length > 0) {
                const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
                const companyCount = companies.size;
                
                // Stability scoring algorithm
                if (avgDuration >= 4) stabilityScore += 40;
                else if (avgDuration >= 3) stabilityScore += 30;
                else if (avgDuration >= 2) stabilityScore += 20;
                else if (avgDuration >= 1) stabilityScore += 10;
                
                if (companyCount <= 2) stabilityScore += 30;
                else if (companyCount <= 4) stabilityScore += 20;
                else if (companyCount <= 6) stabilityScore += 10;
                
                if (totalExperience >= 8) stabilityScore += 20;
                else if (totalExperience >= 5) stabilityScore += 15;
                else if (totalExperience >= 3) stabilityScore += 10;
                
                // Determine stability label
                if (stabilityScore >= 70) stabilityLabel = 'Very Stable';
                else if (stabilityScore >= 50) stabilityLabel = 'Stable';
                else if (stabilityScore >= 30) stabilityLabel = 'Moderate';
                else if (stabilityScore >= 15) stabilityLabel = 'Somewhat Unstable';
                else stabilityLabel = 'Frequent Changes';
                
                // Add detailed analysis
                stabilityLabel += ` (${companyCount} companies, ${totalExperience.toFixed(1)} years avg)`;
            }
            
            return stabilityLabel;
        }

        function extractSkills(text) {
            // Comprehensive skill categories with smart detection
            const skillCategories = {
                'Programming Languages': [
                    'JavaScript', 'Python', 'Java', 'C++', 'C#', 'PHP', 'Ruby', 'Go', 'Rust', 'Swift',
                    'Kotlin', 'Scala', 'TypeScript', 'R', 'MATLAB', 'Perl', 'Shell', 'Bash'
                ],
                'Frontend Technologies': [
                    'React', 'Angular', 'Vue.js', 'Svelte', 'jQuery', 'Bootstrap', 'Tailwind CSS',
                    'HTML', 'CSS', 'SASS', 'LESS', 'Webpack', 'Vite', 'Redux', 'Vuex'
                ],
                'Backend Technologies': [
                    'Node.js', 'Express.js', 'Django', 'Flask', 'Laravel', 'Spring Boot', 'ASP.NET',
                    'FastAPI', 'Ruby on Rails', 'Phoenix', 'Gin', 'Echo'
                ],
                'Databases': [
                    'MySQL', 'PostgreSQL', 'MongoDB', 'Redis', 'Oracle', 'SQL Server', 'SQLite',
                    'Cassandra', 'DynamoDB', 'Elasticsearch', 'Neo4j', 'InfluxDB'
                ],
                'Cloud & DevOps': [
                    'AWS', 'Azure', 'Google Cloud', 'Docker', 'Kubernetes', 'Jenkins', 'Git',
                    'Terraform', 'Ansible', 'Prometheus', 'Grafana', 'ELK Stack'
                ],
                'Data Science & AI': [
                    'Machine Learning', 'AI', 'Data Science', 'Big Data', 'Hadoop', 'Spark',
                    'TensorFlow', 'PyTorch', 'Scikit-learn', 'Pandas', 'NumPy', 'Jupyter'
                ],
                'Mobile Development': [
                    'React Native', 'Flutter', 'Xamarin', 'Ionic', 'Cordova', 'PhoneGap'
                ],
                'Testing & QA': [
                    'Jest', 'Mocha', 'Cypress', 'Selenium', 'JUnit', 'PyTest', 'Postman'
                ]
            };
            
            const foundSkills = [];
            const skillScores = {};
            
            // Smart skill detection with context and scoring
            for (const [category, skills] of Object.entries(skillCategories)) {
                for (const skill of skills) {
                    const skillRegex = new RegExp(`\\b${skill.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                    const matches = text.match(skillRegex);
                    if (matches) {
                        const count = matches.length;
                        const skillName = skill;
                        
                        // Calculate skill relevance score
                        let score = count * 10; // Base score from frequency
                        
                        // Bonus for skills mentioned in experience section
                        if (text.toLowerCase().includes('experience') && text.toLowerCase().includes(skill.toLowerCase())) {
                            score += 20;
                        }
                        
                        // Bonus for skills in projects section
                        if (text.toLowerCase().includes('project') && text.toLowerCase().includes(skill.toLowerCase())) {
                            score += 15;
                        }
                        
                        // Bonus for skills with years of experience
                        const yearPattern = new RegExp(`(\\d+)\\s*(?:years?|yrs?)\\s*.*?${skill.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi');
                        if (yearPattern.test(text)) {
                            score += 25;
                        }
                        
                        skillScores[skillName] = score;
                    }
                }
            }
            
            // Sort skills by relevance score and return top skills
            const sortedSkills = Object.entries(skillScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([skill]) => skill);
            
            return sortedSkills;
        }

        function extractAvailability(text) {
            const availabilityPatterns = [
                /\b(immediate|ready|available|can join|join immediately)\b/i,
                /\b(\d+)\s*(days?|weeks?|months?)\s*(notice|notice period)\b/i,
                /\b(serving notice|notice period|serving)\b/i
            ];
            
            for (const pattern of availabilityPatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[1] && match[2]) {
                        return `${match[1]} ${match[2]}`;
                    }
                    return match[0];
                }
            }
            
            return 'Not Mentioned';
        }

        function extractCurrentCTC(text) {
            // Look for current salary patterns with context
            const ctcPatterns = [
                /\b(current|present|existing)\b.*?(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b/i,
                /\b(current|present|existing)\b.*?(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b/i,
                /\b(salary|CTC|package)\b.*?(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b/i,
                /\b(salary|CTC|package)\b.*?(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b.*?(current|present|existing|salary|CTC|package)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b.*?(current|present|existing|salary|CTC|package)\b/i
            ];
            
            for (const pattern of ctcPatterns) {
                const match = text.match(pattern);
                if (match && (match[1] || match[2])) {
                    const value = parseFloat((match[1] || match[2]).replace(/,/g, ''));
                    if (pattern.source.includes('Crore') || pattern.source.includes('Cr')) {
                        return `${value * 10} LPA`;
                    }
                    return `${value} LPA`;
                }
            }
            
            return 'Not Mentioned';
        }

        function extractExpectedCTC(text) {
            // Look for expected salary patterns with clear context
            const expectedPatterns = [
                /\b(expected|expecting|looking for|seeking|desired|target)\b.*?(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b/i,
                /\b(expected|expecting|looking for|seeking|desired|target)\b.*?(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b.*?(expected|expecting|looking for|seeking|desired|target)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b.*?(expected|expecting|looking for|seeking|desired|target)\b/i
            ];
            
            for (const pattern of expectedPatterns) {
                const match = text.match(pattern);
                if (match && (match[1] || match[2])) {
                    const value = parseFloat((match[1] || match[2]).replace(/,/g, ''));
                    if (pattern.source.includes('Crore') || pattern.source.includes('Cr')) {
                        return `${value * 10} LPA`;
                    }
                    return `${value} LPA`;
                }
            }
            
            return 'Not Mentioned';
        }

        function identifyConcerns(text) {
            const concerns = [];
            
            // Check for gaps
            if (/\b(gap|break|sabbatical|career break)\b/i.test(text)) {
                concerns.push('Career gap detected');
            }
            
            // Check for frequent job changes
            const jobChanges = (text.match(/\b(20\d{2}|19\d{2})\b/g) || []).length;
            if (jobChanges > 3) {
                concerns.push('Multiple job changes');
            }
            
            // Check for missing education
            if (!/\b(degree|bachelor|master|phd|diploma|certification)\b/i.test(text)) {
                concerns.push('Education details unclear');
            }
            
            return concerns.length > 0 ? concerns : ['No major concerns'];
        }

        function calculateMatchScore(resumeData, jobDescription = '') {
            // Enhanced match score calculation with job description analysis
            let score = 50; // Base score
            
            // Ensure resumeData has all required properties
            if (!resumeData) {
                console.warn('resumeData is undefined in calculateMatchScore');
                return 0;
            }
            
            // Skills relevance (40% weight)
            if (resumeData.keySkills && Array.isArray(resumeData.keySkills) && resumeData.keySkills.length > 0) {
                let skillScore = 0;
                const jobSkills = extractJobSkills(jobDescription);
                
                if (jobSkills.length > 0) {
                    // Calculate skill match percentage
                    const matchedSkills = resumeData.keySkills.filter(skill => 
                        jobSkills.some(jobSkill => 
                            skill.toLowerCase().includes(jobSkill.toLowerCase()) ||
                            jobSkill.toLowerCase().includes(skill.toLowerCase())
                        )
                    );
                    skillScore = (matchedSkills.length / Math.max(resumeData.keySkills.length, jobSkills.length)) * 40;
                } else {
                    skillScore = Math.min(resumeData.keySkills.length * 2, 40);
                }
                score += skillScore;
            }
            
            // Experience and stability (25% weight)
            if (resumeData.profileStability && resumeData.profileStability !== 'Not Mentioned') {
                if (resumeData.profileStability.includes('Very Stable')) score += 25;
                else if (resumeData.profileStability.includes('Stable')) score += 20;
                else if (resumeData.profileStability.includes('Moderate')) score += 15;
                else if (resumeData.profileStability.includes('Somewhat Unstable')) score += 10;
                else score += 5;
            }
            
            // Location match (10% weight)
            if (resumeData.location && resumeData.location !== 'Not Mentioned') {
                const jobLocation = extractJobLocation(jobDescription);
                if (jobLocation && resumeData.location.toLowerCase().includes(jobLocation.toLowerCase())) {
                    score += 10;
                } else {
                    score += 5; // Location mentioned but may not match
                }
            }
            
            // Availability (10% weight)
            if (resumeData.availability && resumeData.availability !== 'Not Mentioned') {
                if (resumeData.availability.toLowerCase().includes('immediate')) score += 10;
                else if (resumeData.availability.toLowerCase().includes('30 days') || resumeData.availability.toLowerCase().includes('1 month')) score += 8;
                else if (resumeData.availability.toLowerCase().includes('60 days') || resumeData.availability.toLowerCase().includes('2 month')) score += 6;
                else score += 4;
            }
            
            // CTC information (5% weight)
            if ((resumeData.currentCTC && resumeData.currentCTC !== 'Not Mentioned') || 
                (resumeData.expectedCTC && resumeData.expectedCTC !== 'Not Mentioned')) {
                score += 5;
            }
            
            // Content quality bonus
            const contentQuality = calculateContentQuality(resumeData);
            score += contentQuality;
            
            return Math.min(Math.max(score, 0), 100);
        }
        
        function extractJobSkills(jobDescription) {
            if (!jobDescription) return [];
            
            const skillKeywords = [
                'required', 'must have', 'should have', 'experience with', 'proficient in',
                'knowledge of', 'familiarity with', 'expertise in', 'skills in', 'proficiency in'
            ];
            
            const skills = [];
            const lines = jobDescription.split('\n');
            
            for (const line of lines) {
                for (const keyword of skillKeywords) {
                    if (line.toLowerCase().includes(keyword)) {
                        // Extract skills from this line
                        const skillMatches = line.match(/\b[A-Z][a-zA-Z\s+#&]+(?:\.js|\.net|\.js|\.py|\.java|\.cpp|\.cs|\.php|\.rb|\.go|\.rs|\.swift)\b/g);
                        if (skillMatches) {
                            skills.push(...skillMatches.map(s => s.trim()));
                        }
                    }
                }
            }
            
            return skills;
        }
        
        function extractJobLocation(jobDescription) {
            if (!jobDescription) return null;
            
            const locationPatterns = [
                /\b(location|based in|work from|office in|headquarters in)\s*:?\s*([A-Z][a-zA-Z\s,]+)\b/gi,
                /\b([A-Z][a-zA-Z\s,]+)\s*(?:location|office|headquarters)\b/gi
            ];
            
            for (const pattern of locationPatterns) {
                const match = jobDescription.match(pattern);
                if (match) {
                    return match[1] || match[2];
                }
            }
            
            return null;
        }
        
        function calculateContentQuality(resumeData) {
            let qualityScore = 0;
            
            // Ensure resumeData exists
            if (!resumeData) {
                return 0;
            }
            
            // Check for comprehensive information
            const fields = ['gender', 'location', 'profileStability', 'availability', 'currentCTC', 'expectedCTC'];
            const filledFields = fields.filter(field => resumeData[field] && resumeData[field] !== 'Not Mentioned').length;
            
            qualityScore += (filledFields / fields.length) * 10;
            
            // Bonus for detailed skills
            if (resumeData.keySkills && Array.isArray(resumeData.keySkills) && resumeData.keySkills.length >= 5) {
                qualityScore += 5;
            }
            
            // Bonus for detailed stability analysis
            if (resumeData.profileStability && resumeData.profileStability.includes && resumeData.profileStability.includes('(')) {
                qualityScore += 3;
            }
            
            return Math.min(qualityScore, 10);
        }

        function generateRecommendation(resumeData) {
            const score = resumeData.matchScore;
            
            if (score >= 85) return 'Strong Match - Proceed to Interview';
            if (score >= 75) return 'Good Match - Consider for Next Round';
            if (score >= 65) return 'Moderate Match - Review Further';
            return 'Needs Improvement - Consider for Future';
        }

        // Smart action functions
        function exportCandidateData(candidateName) {
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            // Clean up job description for export
            let cleanJobDescription = 'Not available';
            if (window.currentJobDescription) {
                // If it's a long PDF content, truncate and clean it
                if (window.currentJobDescription.length > 500) {
                    cleanJobDescription = window.currentJobDescription
                        .substring(0, 500)
                        .replace(/[^\x20-\x7E\n]/g, ' ') // Remove non-printable characters
                        .replace(/\s+/g, ' ') // Normalize whitespace
                        .trim() + '... (truncated)';
                } else {
                    cleanJobDescription = window.currentJobDescription;
                }
            }
            
            const data = {
                candidate: candidate,
                exportDate: new Date().toISOString(),
                jobDescription: cleanJobDescription
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${candidateName}_resume_analysis.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Exported ${candidateName}'s data successfully!`);
        }
        
        function scheduleInterview(candidateName) {
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            const interviewDate = prompt(`Schedule interview for ${candidateName} (Enter date in DD/MM/YYYY format):`);
            if (interviewDate) {
                // Here you would integrate with your calendar system
                alert(`Interview scheduled for ${candidateName} on ${interviewDate}`);
                
                // Add to interview schedule
                if (!window.interviewSchedule) window.interviewSchedule = [];
                window.interviewSchedule.push({
                    candidate: candidateName,
                    date: interviewDate,
                    status: 'Scheduled',
                    matchScore: candidate.matchScore
                });
            }
        }
        
        function addToShortlist(candidateName) {
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            if (!window.shortlistedCandidates) window.shortlistedCandidates = [];
            
            const existingIndex = window.shortlistedCandidates.findIndex(c => c.name === candidateName);
            if (existingIndex >= 0) {
                window.shortlistedCandidates.splice(existingIndex, 1);
                alert(`${candidateName} removed from shortlist`);
            } else {
                window.shortlistedCandidates.push({
                    ...candidate,
                    shortlistedDate: new Date().toISOString()
                });
                alert(`${candidateName} added to shortlist!`);
            }
            
            updateShortlistDisplay();
        }
        
        function updateShortlistDisplay() {
            if (!window.shortlistedCandidates || window.shortlistedCandidates.length === 0) return;
            
            // Create or update shortlist display
            let shortlistDiv = document.getElementById('shortlistSection');
            if (!shortlistDiv) {
                shortlistDiv = document.createElement('div');
                shortlistDiv.id = 'shortlistSection';
                shortlistDiv.style.cssText = 'background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; margin: 20px 0;';
                document.getElementById('resultsContent').insertBefore(shortlistDiv, document.getElementById('resultsContent').firstChild);
            }
            
            shortlistDiv.innerHTML = `
                <h3 style="color: #38a169; margin-bottom: 15px;">
                    <i class="fas fa-star"></i> Shortlisted Candidates (${window.shortlistedCandidates.length})
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${window.shortlistedCandidates.map(candidate => `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #c6f6d5;">
                            <div style="font-weight: bold; color: #2d3748;">${candidate.name}</div>
                            <div style="font-size: 0.9rem; color: #718096;">Match: ${candidate.matchScore}%</div>
                            <div style="font-size: 0.9rem; color: #718096;">Shortlisted: ${new Date(candidate.shortlistedDate).toLocaleDateString()}</div>
                            <button onclick="removeFromShortlist('${candidate.name}')" style="background: #f56565; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-top: 8px;">
                                Remove
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function removeFromShortlist(candidateName) {
            if (window.shortlistedCandidates) {
                window.shortlistedCandidates = window.shortlistedCandidates.filter(c => c.name !== candidateName);
                updateShortlistDisplay();
            }
        }
        
        function filterCandidates() {
            if (!window.currentResults) return;
            
            const searchTerm = document.getElementById('candidateSearch').value.toLowerCase();
            const scoreFilter = document.getElementById('scoreFilter').value;
            const locationFilter = document.getElementById('locationFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            
            let filteredResults = window.currentResults.filter(candidate => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    candidate.name.toLowerCase().includes(searchTerm) ||
                    candidate.keySkills.some(skill => skill.toLowerCase().includes(searchTerm)) ||
                    candidate.location.toLowerCase().includes(searchTerm);
                
                // Score filter
                const matchesScore = !scoreFilter || candidate.matchScore >= parseInt(scoreFilter);
                
                // Location filter
                const matchesLocation = !locationFilter || candidate.location === locationFilter;
                
                return matchesSearch && matchesScore && matchesLocation;
            });
            
            // Sort results
            switch (sortBy) {
                case 'name':
                    filteredResults.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'experience':
                    filteredResults.sort((a, b) => {
                        const aExp = parseFloat(a.profileStability.match(/(\d+\.?\d*)/)?.[1] || 0);
                        const bExp = parseFloat(b.profileStability.match(/(\d+\.?\d*)/)?.[1] || 0);
                        return bExp - aExp;
                    });
                    break;
                default: // score
                    filteredResults.sort((a, b) => b.matchScore - a.matchScore);
            }
            
            // Update display with filtered results
            displayFilteredResults(filteredResults);
        }
        
        function displayFilteredResults(filteredResults) {
            const content = document.getElementById('resultsContent');
            
            // Keep the header and filters, update only the candidate sections
            const headerSection = content.querySelector('h2').parentNode;
            const filtersSection = content.querySelector('#candidateSearch').closest('div').parentNode;
            
            // Clear existing candidate sections
            const existingSections = content.querySelectorAll('h3[style*="margin: 30px 0 20px 0"]');
            existingSections.forEach(section => section.remove());
            
            // Categorize filtered candidates
            const strongCandidates = filteredResults.filter(c => c.matchScore >= 80);
            const goodCandidates = filteredResults.filter(c => c.matchScore >= 70 && c.matchScore < 80);
            const moderateCandidates = filteredResults.filter(c => c.matchScore >= 60 && c.matchScore < 70);
            const weakCandidates = filteredResults.filter(c => c.matchScore < 60);
            
            let candidatesHtml = '';
            
            if (strongCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #38a169; margin: 30px 0 20px 0; text-align: center;">🚀 Strong Matches (${strongCandidates.length})</h3>`;
                strongCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            if (goodCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #dd6b20; margin: 30px 0 20px 0; text-align: center;">✅ Good Matches (${goodCandidates.length})</h3>`;
                goodCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            if (moderateCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #d69e2e; margin: 30px 0 20px 0; text-align: center;">🟡 Moderate Matches (${moderateCandidates.length})</h3>`;
                moderateCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            if (weakCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #e53e3e; margin: 30px 0 20px 0; text-align: center;">⚠️ Candidates Needing Review (${weakCandidates.length})</h3>`;
                weakCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            // Insert candidates after filters
            filtersSection.insertAdjacentHTML('afterend', candidatesHtml);
            
            // Update shortlist if it exists
            if (window.shortlistedCandidates && window.shortlistedCandidates.length > 0) {
                updateShortlistDisplay();
            }
        }
        
        // Initialize file handlers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, file handlers initialized');
            
            // Initialize global variables
            window.currentResults = null;
            window.currentJobDescription = null;
            window.shortlistedCandidates = [];
            window.interviewSchedule = [];
        });
    </script>
</body>
</html>
