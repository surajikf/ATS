<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKF HR - Smart Resume Screening Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 { 
            color: white;
            font-size: 2.5rem; 
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p { 
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .screening-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #4a5568;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex; 
            align-items: center;
            gap: 10px;
        }

        .form-section h3 i {
            color: #667eea;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer; 
            transition: all 0.3s ease;
            background: #f7fafc;
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }

        .file-upload-area p {
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .file-upload-area small {
            color: #718096;
            font-size: 0.9rem;
        }

        .file-upload-area input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .results-section {
            margin-top: 40px;
            display: none;
        }

        .candidate-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f7fafc;
        }

        .candidate-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
        }

        .match-score {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600; 
            font-size: 1.1rem;
        }

        .candidate-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 500;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1rem; 
            color: #2d3748;
            font-weight: 600;
        }

        .skills-section, .concerns-section {
            margin-top: 20px;
        }

        .skills-section h4, .concerns-section h4 {
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .skills-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-tag {
            background: #edf2f7;
            color: #4a5568;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .concern-tag {
            background: #fed7d7;
            color: #c53030;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .recommendation {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .recommendation h4 {
            color: #2d3748;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .recommendation p {
            color: #4a5568;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c53030;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .screening-form {
                padding: 25px;
            }
            
            .candidate-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
                 <div class="header">
             <h1><i class="fas fa-user-tie"></i> IKF HR</h1>
             <p>Smart Resume Screening Assistant - Professional Candidate Assessment</p>
             <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">AI-powered resume analysis with real data extraction</p>
         </div>

        <div class="screening-form">
            <div class="form-section">
                <h3><i class="fas fa-briefcase"></i> Job Description</h3>
                <div class="file-upload-area" onclick="triggerFileUpload('jobDescriptionFile')">
                    <i class="fas fa-file-alt"></i>
                    <p>Upload Job Description</p>
                    <small>PDF, DOC, DOCX, or TXT files accepted</small>
                    <input type="file" id="jobDescriptionFile" accept=".pdf,.doc,.docx,.txt" onchange="updateJobFileInfo()">
                </div>
                <div id="jobFileInfo" style="margin-top: 10px; font-size: 0.9rem; color: #48bb78;"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-users"></i> Candidate Resumes</h3>
                <div class="file-upload-area" onclick="triggerFileUpload('resumeFiles')">
                    <i class="fas fa-file-upload"></i>
                    <p>Upload Resume(s)</p>
                    <small>Multiple files accepted. PDF, DOC, DOCX, or TXT</small>
                    <input type="file" id="resumeFiles" accept=".pdf,.doc,.docx,.txt" multiple onchange="updateResumeFileInfo()">
                </div>
                <div id="resumeFileInfo" style="margin-top: 10px; font-size: 0.9rem; color: #48bb78;"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startScreening()" id="screeningBtn">
                    <i class="fas fa-search"></i> Start Smart Screening
                </button>
            </div>
        </div>

        <!-- Job Description Storage Section -->
        <div class="form-section" style="margin-top: 20px;">
            <h3><i class="fas fa-save"></i> Job Description Storage</h3>
            
            <!-- Current Job Description Display -->
            <div id="currentJobDescription"></div>
            
            <!-- Saved Job Descriptions -->
            <div id="savedJobDescriptions"></div>
            
            <!-- Quick Actions -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="displaySavedJobDescriptions()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-list"></i> View Saved JDs
                </button>
                <button onclick="clearCurrentJobDescription()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-trash"></i> Clear Current JD
                </button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
                         <div class="loading" id="loadingSection">
                 <i class="fas fa-spinner"></i>
                 <p>Reading and analyzing resume content...</p>
             </div>
            
            <div id="resultsContent" style="display: none;">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentJobFile = null;
        let currentResumeFiles = [];
        let currentResults = [];
        let shortlistedCandidates = [];
        let interviewSchedule = [];
        let savedJobDescriptions = JSON.parse(localStorage.getItem('savedJobDescriptions') || '[]');
        let currentJobDescription = localStorage.getItem('currentJobDescription') || '';

        function triggerFileUpload(inputId) {
            document.getElementById(inputId).click();
        }

        function updateJobFileInfo() {
            const input = document.getElementById('jobDescriptionFile');
            const info = document.getElementById('jobFileInfo');
            if (input.files.length > 0) {
                info.textContent = `Selected: ${input.files[0].name}`;
            }
        }

        function updateResumeFileInfo() {
            const input = document.getElementById('resumeFiles');
            const info = document.getElementById('resumeFileInfo');
            if (input.files.length > 0) {
                const count = input.files.length;
                const names = Array.from(input.files).map(f => f.name).join(', ');
                info.textContent = `Selected ${count} file(s): ${names}`;
            }
        }

        function startScreening() {
            const jobFile = document.getElementById('jobDescriptionFile').files[0];
            const resumeFiles = document.getElementById('resumeFiles').files;

            // Check if we have a job description (either uploaded or saved)
            if (!jobFile && !window.currentJobDescription) {
                alert('Please upload a job description first or use a saved one.');
                return;
            }

            if (resumeFiles.length === 0) {
                alert('Please upload at least one resume.');
                return;
            }

            console.log('Starting screening with:', { jobFile: jobFile.name, resumeCount: resumeFiles.length });

            // Show results section and loading
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('screeningBtn').disabled = true;

            console.log('Results section displayed:', document.getElementById('resultsSection').style.display);

            // Simulate AI processing (replace with actual backend call)
            setTimeout(() => {
                console.log('Timeout completed, calling processScreeningResults');
                processScreeningResults(jobFile, resumeFiles);
            }, 2000);
        }

        async function processScreeningResults(jobFile, resumeFiles) {
            console.log('processScreeningResults called with:', { jobFile: jobFile?.name, resumeCount: resumeFiles.length });
            
            try {
                // Hide loading, show results
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('resultsContent').style.display = 'block';
                document.getElementById('screeningBtn').disabled = false;

                console.log('Loading hidden, results content shown');

                // Get job description (either from uploaded file or saved)
                let jobDescription;
                if (jobFile) {
                    // Parse uploaded job description
                    jobDescription = await parseResumeContent(jobFile);
                    console.log('Job description parsed from file, length:', jobDescription.length);
                    
                    // Store job description globally and save it
                    window.currentJobDescription = jobDescription;
                    saveJobDescription(jobDescription, jobFile.name);
                } else {
                    // Use saved job description
                    jobDescription = window.currentJobDescription;
                    console.log('Using saved job description, length:', jobDescription.length);
                }
                
                // Actually parse and analyze the resume files with job description
                const results = await parseResumeFiles(resumeFiles, jobDescription);
                console.log('Resume parsing completed, results:', results);
                
                displayResults(results);
                console.log('Results displayed');
                
            } catch (error) {
                console.error('Error in processScreeningResults:', error);
                alert('Error processing screening results: ' + error.message);
            }
        }

        async function parseResumeFiles(resumeFiles, jobDescription = '') {
            const results = [];
            
            for (let i = 0; i < resumeFiles.length; i++) {
                const file = resumeFiles[i];
                const candidateName = file.name.replace(/\.[^/.]+$/, ''); // Remove file extension
                
                try {
                    // Parse the actual resume file content
                    const resumeData = await parseResumeContent(file);
                    
                    // Ensure all extracted data is properly initialized
                    const extractedData = {
                        name: candidateName,
                        fileName: file.name,
                        location: extractLocation(resumeData) || 'Not Mentioned',
                        profileStability: analyzeProfileStability(resumeData) || 'Not Mentioned',
                        keySkills: extractSkills(resumeData) || [],
                        availability: extractAvailability(resumeData) || 'Not Mentioned',
                        currentCTC: extractCurrentCTC(resumeData) || 'Not Mentioned',
                        expectedCTC: extractExpectedCTC(resumeData) || 'Not Mentioned',
                        concerns: identifyConcerns(resumeData) || [],
                        // Additional HR Criteria
                        educationLevel: extractEducationLevel(resumeData) || 'Not Mentioned',
                        experienceYears: extractExperienceYears(resumeData) || 'Not Mentioned',
                        noticePeriod: extractNoticePeriod(resumeData) || 'Not Mentioned',
                        certifications: extractCertifications(resumeData) || [],
                        languages: extractLanguages(resumeData) || [],
                        workAuthorization: extractWorkAuthorization(resumeData) || 'Not Mentioned',
                        relocationWillingness: extractRelocationWillingness(resumeData) || 'Not Mentioned',
                        // Contact Information
                        mobileNumber: extractMobileNumber(resumeData) || null
                    };
                    
                    // Calculate match score with job description comparison
                    extractedData.matchScore = Math.round(calculateMatchScore(extractedData, jobDescription));
                    
                    // Generate recommendation
                    extractedData.recommendation = generateRecommendation(extractedData);
                    
                    results.push(extractedData);
                    
                } catch (error) {
                    console.error(`Error processing file ${file.name}:`, error);
                    
                    // Add fallback data for failed parsing
                    results.push({
                        name: candidateName,
                        fileName: file.name,
                        matchScore: 0,
                        location: 'Error in parsing',
                        profileStability: 'Error in parsing',
                        keySkills: [],
                        availability: 'Error in parsing',
                        currentCTC: 'Error in parsing',
                        expectedCTC: 'Error in parsing',
                        concerns: ['File parsing failed'],
                        recommendation: 'Analysis failed - please check file format',
                        // Additional HR Criteria
                        educationLevel: 'Error in parsing',
                        experienceYears: 'Error in parsing',
                        noticePeriod: 'Error in parsing',
                        certifications: ['Error in parsing'],
                        languages: ['Error in parsing'],
                        workAuthorization: 'Error in parsing',
                        relocationWillingness: 'Error in parsing',
                        mobileNumber: null
                    });
                }
            }
            
            return results;
        }

        function displayResults(results) {
            console.log('displayResults called with:', results);
            
            const content = document.getElementById('resultsContent');
            console.log('Results content element:', content);
            
            if (!content) {
                console.error('resultsContent element not found!');
                return;
            }
            
            // Store results globally for other functions to use
            window.currentResults = results;
            
            // Sort candidates by match score (highest first)
            const sortedResults = [...results].sort((a, b) => b.matchScore - a.matchScore);
            
            // Categorize candidates
            const strongCandidates = sortedResults.filter(c => c.matchScore >= 80);
            const goodCandidates = sortedResults.filter(c => c.matchScore >= 70 && c.matchScore < 80);
            const moderateCandidates = sortedResults.filter(c => c.matchScore >= 60 && c.matchScore < 70);
            const weakCandidates = sortedResults.filter(c => c.matchScore < 60);
            
            let html = `
                <h2 style="color: #2d3748; margin-bottom: 30px; text-align: center;">Smart Screening Results</h2>
                
                <!-- Summary Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #38a169; margin-bottom: 10px;">🚀 Strong Matches</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #38a169;">${strongCandidates.length}</div>
                        <small style="color: #718096;">80%+ Match</small>
                        </div>
                    <div style="background: #fef5e7; border: 2px solid #ed8936; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #dd6b20; margin-bottom: 10px;">✅ Good Matches</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #dd6b20;">${goodCandidates.length}</div>
                        <small style="color: #718096;">70-79% Match</small>
                        </div>
                    <div style="background: #fef8e7; border: 2px solid #ecc94b; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #d69e2e; margin-bottom: 10px;">🟡 Moderate</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #d69e2e;">${moderateCandidates.length}</div>
                        <small style="color: #718096;">60-69% Match</small>
                    </div>
                    <div style="background: #fed7d7; border: 2px solid #f56565; border-radius: 12px; padding: 20px; text-align: center;">
                        <h3 style="color: #e53e3e; margin-bottom: 10px;">⚠️ Needs Review</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #e53e3e;">${weakCandidates.length}</div>
                        <small style="color: #718096;">< 60% Match</small>
                        </div>
                    </div>
                    
                <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #4a5568; margin-bottom: 15px; text-align: center;">📋 Resume Analysis Summary</h3>
                    <p style="color: #718096; line-height: 1.6; text-align: center; margin-bottom: 20px;">
                        <strong>${results.length} resume file(s)</strong> have been analyzed using AI-powered screening.<br>
                        The system has extracted real candidate information and compared it against the job description.<br>
                        <em>All data shown is extracted directly from resume content with intelligent scoring.</em>
                    </p>
                    
                    <!-- Smart Search and Filters -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Search Candidates:</label>
                            <input type="text" id="candidateSearch" placeholder="Search by name, skills, location..." 
                                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;"
                                   onkeyup="filterCandidates()">
                            </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Filter by Match Score:</label>
                            <select id="scoreFilter" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" onchange="filterCandidates()">
                                <option value="">All Scores</option>
                                <option value="80">80%+ (Strong)</option>
                                <option value="70">70%+ (Good)</option>
                                <option value="60">60%+ (Moderate)</option>
                            </select>
                            </div>
                            <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Filter by Location:</label>
                            <select id="locationFilter" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" onchange="filterCandidates()">
                                <option value="">All Locations</option>
                                ${[...new Set(results.map(r => r.location).filter(l => l !== 'Not Mentioned'))].map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                            </select>
                            </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Sort By:</label>
                            <select id="sortFilter" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" onchange="filterCandidates()">
                                <option value="score">Match Score (High to Low)</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="experience">Experience (High to Low)</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            if (results.length > 1) {
                // Comparison table for multiple candidates
                html += createComparisonTable(sortedResults);
            }
            
            // Show candidates by category
            if (strongCandidates.length > 0) {
                html += `<h3 style="color: #38a169; margin: 30px 0 20px 0; text-align: center;">🚀 Strong Matches (${strongCandidates.length})</h3>`;
                strongCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            if (goodCandidates.length > 0) {
                html += `<h3 style="color: #dd6b20; margin: 30px 0 20px 0; text-align: center;">✅ Good Matches (${goodCandidates.length})</h3>`;
                goodCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            if (moderateCandidates.length > 0) {
                html += `<h3 style="color: #d69e2e; margin: 30px 0 20px 0; text-align: center;">🟡 Moderate Matches (${moderateCandidates.length})</h3>`;
                moderateCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            if (weakCandidates.length > 0) {
                html += `<h3 style="color: #e53e3e; margin: 30px 0 20px 0; text-align: center;">⚠️ Candidates Needing Review (${weakCandidates.length})</h3>`;
                weakCandidates.forEach(candidate => {
                    html += createCandidateCard(candidate);
                });
            }
            
            content.innerHTML = html;
        }

        function createComparisonTable(results) {
            let html = `
                <div class="candidate-card" style="margin-bottom: 30px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-table"></i> Candidate Comparison
                    </h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f7fafc;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Candidate</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Match %</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Top Skills</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Concerns</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">Recommendation</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            results.forEach(candidate => {
                html += `
                    <tr>
                                                 <td style="padding: 12px; border-bottom: 1px solid #f7fafc; font-weight: 600;">
                             <div>${candidate.name}</div>
                             <div style="font-size: 0.8rem; color: #718096; font-style: italic;">📄 ${candidate.fileName}</div>
                         </td>
                        <td style="padding: 12px; border-bottom: 1px solid #f7fafc; text-align: center;">
                                                            <span class="match-score" style="font-size: 0.8rem;">${Math.round(candidate.matchScore)}%</span>
                        </td>
                                                 <td style="padding: 12px; border-bottom: 1px solid #f7fafc;">
                             ${candidate.keySkills.length > 0 ? candidate.keySkills.slice(0, 3).map(skill => `<span class="skill-tag">${skill}</span>`).join(' ') : '<span style="color: #718096; font-style: italic;">Not Mentioned</span>'}
                         </td>
                         <td style="padding: 12px; border-bottom: 1px solid #f7fafc;">
                             ${candidate.concerns.length > 0 ? candidate.concerns.map(concern => `<span class="concern-tag">${concern}</span>`).join(' ') : '<span style="color: #718096; font-style: italic;">No Concerns</span>'}
                         </td>
                                                 <td style="padding: 12px; border-bottom: 1px solid #f7fafc; text-align: center; font-size: 0.8rem;">
                             ${candidate.matchScore > 0 ? (candidate.matchScore > 80 ? '✅ Strong' : candidate.matchScore > 70 ? '🟡 Good' : '🟠 Review') : '⏳ Pending'}
                         </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                        </div>
                        </div>
            `;
            
            return html;
        }

        function createCandidateCard(candidate) {
            return `
                <div class="candidate-card">
                                         <div class="candidate-header">
                         <div>
                             <div class="candidate-name">${candidate.name}</div>
                             <div style="font-size: 0.9rem; color: #718096; margin-top: 5px; font-style: italic;">📄 ${candidate.fileName}</div>
                        </div>
                         <div class="match-score">${candidate.matchScore > 0 ? Math.round(candidate.matchScore) + '% Match' : 'Pending Analysis'}</div>
                    </div>
                    
                    <div class="candidate-details">
                        
                        <div class="detail-item">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${candidate.location}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Profile Stability</div>
                            <div class="detail-value">${candidate.profileStability}</div>
                    </div>
                        <div class="detail-item">
                            <div class="detail-label">Availability</div>
                            <div class="detail-value">${candidate.availability}</div>
                </div>
                        <div class="detail-item">
                            <div class="detail-label">Current CTC</div>
                            <div class="detail-value">${candidate.currentCTC}</div>
            </div>
                        <div class="detail-item">
                            <div class="detail-label">Expected CTC</div>
                            <div class="detail-value">${candidate.expectedCTC}</div>
        </div>
            </div>
            
                                         <div class="skills-section">
                         <h4><i class="fas fa-star"></i> Key Skills (Relevant to JD)</h4>
                         <div class="skills-grid">
                             ${candidate.keySkills.length > 0 ? candidate.keySkills.map(skill => `<span class="skill-tag">${skill}</span>`).join('') : '<span style="color: #718096; font-style: italic; padding: 10px;">No skills information available</span>'}
                </div>
            </div>
            
                     <div class="concerns-section">
                         <h4><i class="fas fa-exclamation-triangle"></i> Areas of Concern</h4>
                         <div class="skills-grid">
                             ${candidate.concerns.length > 0 ? candidate.concerns.map(concern => `<span class="concern-tag">${concern}</span>`).join('') : '<span style="color: #718096; font-style: italic; padding: 10px;">No concerns identified</span>'}
                </div>
            </div>
            
                                         <div class="recommendation">
                         <h4><i class="fas fa-lightbulb"></i> Recruiter's Recommendation</h4>
                         <p><strong>${candidate.recommendation}</strong></p>
                         <p style="margin-top: 10px; font-size: 0.9rem;">
                             ${candidate.matchScore > 0 ? 
                               `Based on ${Math.round(candidate.matchScore)}% match with job requirements. ${candidate.matchScore > 80 ? 'Strong candidate profile with relevant skills and experience.' : candidate.matchScore > 70 ? 'Good potential match, recommend further evaluation.' : 'Moderate match, consider for specific requirements or backup candidate.'}` : 
                               'Resume analysis required. Please upload resume and job description for evaluation.'}
                         </p>
                         
                         <!-- Action Buttons -->
                         <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                             <button onclick="exportCandidateData('${candidate.name}')" style="background: #4299e1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                 <i class="fas fa-download"></i> Export Data
                             </button>
                             <button onclick="scheduleInterview('${candidate.name}')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                 <i class="fas fa-calendar"></i> Schedule Interview
                             </button>
                             <button onclick="addToShortlist('${candidate.name}')" style="background: #ed8936; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                 <i class="fas fa-star"></i> Add to Shortlist
                             </button>
                             ${candidate.mobileNumber ? 
                                 `<button onclick="sendWhatsAppInvite('${candidate.name}')" style="background: #25d366; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                     <i class="fab fa-whatsapp"></i> Send WhatsApp Invite
                                 </button>` : 
                                 `<button disabled style="background: #cbd5e0; color: #718096; border: none; padding: 8px 16px; border-radius: 6px; cursor: not-allowed; font-size: 0.9rem;">
                                     <i class="fas fa-phone"></i> No Mobile Number
                                 </button>`
                             }
            </div>
                </div>
                </div>
            `;
        }

        // Resume parsing functions
        function parseResumeContent(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        
                        // If it's a PDF, try to extract text content
                        if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                            // For PDFs, we'll try to extract readable text
                            const cleanContent = extractPDFText(content);
                            resolve(cleanContent);
                        } else {
                            // For text files, use as is
                            resolve(content);
                        }
                    } catch (error) {
                        console.warn('Error parsing file content:', error);
                        resolve('File content could not be parsed');
                    }
                };
                reader.onerror = () => resolve('File could not be read');
                
                // For PDFs, read as ArrayBuffer to handle binary content
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });
        }

        function extractPDFText(pdfContent) {
            try {
                // Convert ArrayBuffer to string and extract readable text
                const decoder = new TextDecoder('utf-8');
                const content = decoder.decode(pdfContent);
                
                // Remove PDF metadata and extract actual text content
                // Look for text between parentheses and brackets
                const textMatches = content.match(/\(([^)]+)\)/g) || [];
                const bracketMatches = content.match(/\[([^\]]+)\]/g) || [];
                
                // Extract meaningful text content
                let extractedText = '';
                
                // Add text from parentheses
                textMatches.forEach(match => {
                    const text = match.replace(/[()]/g, '').trim();
                    if (text.length > 3 && !text.includes('obj') && !text.includes('R')) {
                        extractedText += text + ' ';
                    }
                });
                
                // Add text from brackets
                bracketMatches.forEach(match => {
                    const text = match.replace(/[\[\]]/g, '').trim();
                    if (text.length > 3 && !text.includes('obj') && !text.includes('R')) {
                        extractedText += text + ' ';
                    }
                });
                
                // If we have extracted text, return it
                if (extractedText.trim().length > 0) {
                    return extractedText.trim();
                }
                
                // Fallback: try to extract any readable text
                const readableText = content
                    .replace(/[^\x20-\x7E\n]/g, ' ') // Remove non-printable characters
                    .replace(/\s+/g, ' ') // Normalize whitespace
                    .trim();
                
                return readableText || 'PDF content could not be extracted';
                
            } catch (error) {
                console.warn('Error extracting PDF text:', error);
                return 'PDF content could not be extracted';
            }
        }



        function extractLocation(text) {
            // Common city patterns
            const cityPattern = /\b(Mumbai|Delhi|Bangalore|Hyderabad|Chennai|Pune|Kolkata|Ahmedabad|Jaipur|Surat|Lucknow|Kanpur|Nagpur|Indore|Thane|Bhopal|Visakhapatnam|Pimpri|Patna|Vadodara|Ghaziabad|Ludhiana|Agra|Nashik|Ranchi|Faridabad|Meerut|Rajkot|Kalyan|Vasai|Varanasi|Srinagar|Aurangabad|Navi Mumbai|Solapur|Kolhapur|Shimla|Dehradun|Gurgaon|Noida|Greater Noida|Faridabad|Gurugram)\b/i;
            
            const match = text.match(cityPattern);
            if (match) {
                return match[0];
            }
            
            // Look for state patterns
            const statePattern = /\b(Maharashtra|Delhi|Karnataka|Telangana|Tamil Nadu|Uttar Pradesh|West Bengal|Gujarat|Rajasthan|Punjab|Haryana|Bihar|Madhya Pradesh|Andhra Pradesh|Jharkhand|Chhattisgarh|Uttarakhand|Himachal Pradesh|Assam|Odisha|Kerala|Jammu and Kashmir|Manipur|Meghalaya|Nagaland|Tripura|Arunachal Pradesh|Mizoram|Sikkim|Goa)\b/i;
            
            const stateMatch = text.match(statePattern);
            if (stateMatch) {
                return stateMatch[0];
            }
            
            return 'Not Mentioned';
        }

        function analyzeProfileStability(text) {
            // Enhanced profile stability analysis with multiple factors
            const jobPatterns = [
                // Look for job entries with dates
                /\b(20\d{2}|19\d{2})\s*[-–—]\s*(20\d{2}|19\d{2}|present|current|till date|ongoing)\b/gi,
                // Look for duration patterns
                /\b(\d+)\s*(years?|yrs?|months?|mos?)\b/gi,
                // Look for company names with durations
                /\b(?:at|with|worked at|employed at)\s+[A-Z][a-zA-Z\s&]+(?:for|over|duration|period)\s+(\d+)\s*(years?|yrs?|months?|mos?)\b/gi
            ];
            
            const durations = [];
            const jobChanges = [];
            let totalExperience = 0;
            
            // Extract job durations and changes
            for (const pattern of jobPatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    if (match[1]) {
                        const value = parseInt(match[1]);
                        const unit = match[2] ? match[2].toLowerCase() : 'years';
                        
                        if (unit.includes('year') || unit.includes('yr')) {
                            durations.push(value);
                            totalExperience += value;
                        } else if (unit.includes('month') || unit.includes('mo')) {
                            const yearValue = value / 12;
                            durations.push(yearValue);
                            totalExperience += yearValue;
                        }
                    }
                }
            }
            
            // Count job changes from company names and dates
            const companyPattern = /\b(?:at|with|worked at|employed at|joined|started)\s+([A-Z][a-zA-Z\s&]+(?:Inc|Ltd|Corp|Company|Tech|Solutions|Systems|Services|Consulting|Group|LLC|Pvt|Private|Limited))\b/gi;
            const companies = new Set();
            let companyMatch;
            while ((companyMatch = companyPattern.exec(text)) !== null) {
                companies.add(companyMatch[1].trim());
            }
            
            // Calculate stability score
            let stabilityScore = 0;
            let stabilityLabel = 'Not Mentioned';
            
            if (durations.length > 0) {
                const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
                const companyCount = companies.size;
                
                // Stability scoring algorithm
                if (avgDuration >= 4) stabilityScore += 40;
                else if (avgDuration >= 3) stabilityScore += 30;
                else if (avgDuration >= 2) stabilityScore += 20;
                else if (avgDuration >= 1) stabilityScore += 10;
                
                if (companyCount <= 2) stabilityScore += 30;
                else if (companyCount <= 4) stabilityScore += 20;
                else if (companyCount <= 6) stabilityScore += 10;
                
                if (totalExperience >= 8) stabilityScore += 20;
                else if (totalExperience >= 5) stabilityScore += 15;
                else if (totalExperience >= 3) stabilityScore += 10;
                
                // Determine stability label
                if (stabilityScore >= 70) stabilityLabel = 'Very Stable';
                else if (stabilityScore >= 50) stabilityLabel = 'Stable';
                else if (stabilityScore >= 30) stabilityLabel = 'Moderate';
                else if (stabilityScore >= 15) stabilityLabel = 'Somewhat Unstable';
                else stabilityLabel = 'Frequent Changes';
                
                // Add detailed analysis
                stabilityLabel += ` (${companyCount} companies, ${totalExperience.toFixed(1)} years avg)`;
            }
            
            return stabilityLabel;
        }

        function extractSkills(text) {
            // Comprehensive skill categories with smart detection
            const skillCategories = {
                'Programming Languages': [
                    'JavaScript', 'Python', 'Java', 'C++', 'C#', 'PHP', 'Ruby', 'Go', 'Rust', 'Swift',
                    'Kotlin', 'Scala', 'TypeScript', 'R', 'MATLAB', 'Perl', 'Shell', 'Bash'
                ],
                'Frontend Technologies': [
                    'React', 'Angular', 'Vue.js', 'Svelte', 'jQuery', 'Bootstrap', 'Tailwind CSS',
                    'HTML', 'CSS', 'SASS', 'LESS', 'Webpack', 'Vite', 'Redux', 'Vuex'
                ],
                'Backend Technologies': [
                    'Node.js', 'Express.js', 'Django', 'Flask', 'Laravel', 'Spring Boot', 'ASP.NET',
                    'FastAPI', 'Ruby on Rails', 'Phoenix', 'Gin', 'Echo'
                ],
                'Databases': [
                    'MySQL', 'PostgreSQL', 'MongoDB', 'Redis', 'Oracle', 'SQL Server', 'SQLite',
                    'Cassandra', 'DynamoDB', 'Elasticsearch', 'Neo4j', 'InfluxDB'
                ],
                'Cloud & DevOps': [
                    'AWS', 'Azure', 'Google Cloud', 'Docker', 'Kubernetes', 'Jenkins', 'Git',
                    'Terraform', 'Ansible', 'Prometheus', 'Grafana', 'ELK Stack'
                ],
                'Data Science & AI': [
                    'Machine Learning', 'AI', 'Data Science', 'Big Data', 'Hadoop', 'Spark',
                    'TensorFlow', 'PyTorch', 'Scikit-learn', 'Pandas', 'NumPy', 'Jupyter'
                ],
                'Mobile Development': [
                    'React Native', 'Flutter', 'Xamarin', 'Ionic', 'Cordova', 'PhoneGap'
                ],
                'Testing & QA': [
                    'Jest', 'Mocha', 'Cypress', 'Selenium', 'JUnit', 'PyTest', 'Postman'
                ]
            };
            
            const foundSkills = [];
            const skillScores = {};
            
            // Smart skill detection with context and scoring
            for (const [category, skills] of Object.entries(skillCategories)) {
                for (const skill of skills) {
                    const skillRegex = new RegExp(`\\b${skill.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                    const matches = text.match(skillRegex);
                    if (matches) {
                        const count = matches.length;
                        const skillName = skill;
                        
                        // Calculate skill relevance score
                        let score = count * 10; // Base score from frequency
                        
                        // Bonus for skills mentioned in experience section
                        if (text.toLowerCase().includes('experience') && text.toLowerCase().includes(skill.toLowerCase())) {
                            score += 20;
                        }
                        
                        // Bonus for skills in projects section
                        if (text.toLowerCase().includes('project') && text.toLowerCase().includes(skill.toLowerCase())) {
                            score += 15;
                        }
                        
                        // Bonus for skills with years of experience
                        const yearPattern = new RegExp(`(\\d+)\\s*(?:years?|yrs?)\\s*.*?${skill.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi');
                        if (yearPattern.test(text)) {
                            score += 25;
                        }
                        
                        skillScores[skillName] = score;
                    }
                }
            }
            
            // Sort skills by relevance score and return top skills
            const sortedSkills = Object.entries(skillScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([skill]) => skill);
            
            return sortedSkills;
        }

        function extractAvailability(text) {
            const availabilityPatterns = [
                /\b(immediate|ready|available|can join|join immediately)\b/i,
                /\b(\d+)\s*(days?|weeks?|months?)\s*(notice|notice period)\b/i,
                /\b(serving notice|notice period|serving)\b/i
            ];
            
            for (const pattern of availabilityPatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[1] && match[2]) {
                        return `${match[1]} ${match[2]}`;
                    }
                    return match[0];
                }
            }
            
            return 'Not Mentioned';
        }

        function extractCurrentCTC(text) {
            // Look for current salary patterns with context
            const ctcPatterns = [
                /\b(current|present|existing)\b.*?(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b/i,
                /\b(current|present|existing)\b.*?(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b/i,
                /\b(salary|CTC|package)\b.*?(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b/i,
                /\b(salary|CTC|package)\b.*?(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b.*?(current|present|existing|salary|CTC|package)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b.*?(current|present|existing|salary|CTC|package)\b/i
            ];
            
            for (const pattern of ctcPatterns) {
                const match = text.match(pattern);
                if (match && (match[1] || match[2])) {
                    const value = parseFloat((match[1] || match[2]).replace(/,/g, ''));
                    if (pattern.source.includes('Crore') || pattern.source.includes('Cr')) {
                        return `${value * 10} LPA`;
                    }
                    return `${value} LPA`;
                }
            }
            
            return 'Not Mentioned';
        }

        function extractExpectedCTC(text) {
            // Look for expected salary patterns with clear context
            const expectedPatterns = [
                /\b(expected|expecting|looking for|seeking|desired|target)\b.*?(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b/i,
                /\b(expected|expecting|looking for|seeking|desired|target)\b.*?(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:LPA|lpa|Lakh|Lac|L)\b.*?(expected|expecting|looking for|seeking|desired|target)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:Crore|Cr)\b.*?(expected|expecting|looking for|seeking|desired|target)\b/i
            ];
            
            for (const pattern of expectedPatterns) {
                const match = text.match(pattern);
                if (match && (match[1] || match[2])) {
                    const value = parseFloat((match[1] || match[2]).replace(/,/g, ''));
                    if (pattern.source.includes('Crore') || pattern.source.includes('Cr')) {
                        return `${value * 10} LPA`;
                    }
                    return `${value} LPA`;
                }
            }
            
            return 'Not Mentioned';
        }

        function identifyConcerns(text) {
            const concerns = [];
            
            // Check for gaps
            if (/\b(gap|break|sabbatical|career break)\b/i.test(text)) {
                concerns.push('Career gap detected');
            }
            
            // Check for frequent job changes
            const jobChanges = (text.match(/\b(20\d{2}|19\d{2})\b/g) || []).length;
            if (jobChanges > 3) {
                concerns.push('Multiple job changes');
            }
            
            // Check for missing education
            if (!/\b(degree|bachelor|master|phd|diploma|certification)\b/i.test(text)) {
                concerns.push('Education details unclear');
            }
            
            return concerns.length > 0 ? concerns : ['No major concerns'];
        }

        function calculateMatchScore(resumeData, jobDescription = '') {
            // Enhanced match score calculation with job description analysis
            let score = 50; // Base score
            
            // Ensure resumeData has all required properties
            if (!resumeData) {
                console.warn('resumeData is undefined in calculateMatchScore');
                return 0;
            }
            
            // Skills relevance (40% weight)
            if (resumeData.keySkills && Array.isArray(resumeData.keySkills) && resumeData.keySkills.length > 0) {
                let skillScore = 0;
                const jobSkills = extractJobSkills(jobDescription);
                
                if (jobSkills.length > 0) {
                    // Calculate skill match percentage
                    const matchedSkills = resumeData.keySkills.filter(skill => 
                        jobSkills.some(jobSkill => 
                            skill.toLowerCase().includes(jobSkill.toLowerCase()) ||
                            jobSkill.toLowerCase().includes(skill.toLowerCase())
                        )
                    );
                    skillScore = (matchedSkills.length / Math.max(resumeData.keySkills.length, jobSkills.length)) * 40;
            } else {
                    skillScore = Math.min(resumeData.keySkills.length * 2, 40);
                }
                score += skillScore;
            }
            
            // Experience and stability (25% weight)
            if (resumeData.profileStability && resumeData.profileStability !== 'Not Mentioned') {
                if (resumeData.profileStability.includes('Very Stable')) score += 25;
                else if (resumeData.profileStability.includes('Stable')) score += 20;
                else if (resumeData.profileStability.includes('Moderate')) score += 15;
                else if (resumeData.profileStability.includes('Somewhat Unstable')) score += 10;
                else score += 5;
            }
            
            // Location match (10% weight)
            if (resumeData.location && resumeData.location !== 'Not Mentioned') {
                const jobLocation = extractJobLocation(jobDescription);
                if (jobLocation && resumeData.location.toLowerCase().includes(jobLocation.toLowerCase())) {
                    score += 10;
                } else {
                    score += 5; // Location mentioned but may not match
                }
            }
            
            // Availability (10% weight)
            if (resumeData.availability && resumeData.availability !== 'Not Mentioned') {
                if (resumeData.availability.toLowerCase().includes('immediate')) score += 10;
                else if (resumeData.availability.toLowerCase().includes('30 days') || resumeData.availability.toLowerCase().includes('1 month')) score += 8;
                else if (resumeData.availability.toLowerCase().includes('60 days') || resumeData.availability.toLowerCase().includes('2 month')) score += 6;
                else score += 4;
            }
            
            // CTC information (5% weight)
            if ((resumeData.currentCTC && resumeData.currentCTC !== 'Not Mentioned') || 
                (resumeData.expectedCTC && resumeData.expectedCTC !== 'Not Mentioned')) {
                score += 5;
            }
            
            // Content quality bonus
            const contentQuality = calculateContentQuality(resumeData);
            score += contentQuality;
            
            return Math.min(Math.max(score, 0), 100);
        }
        
        function extractJobSkills(jobDescription) {
            if (!jobDescription) return [];
            
            const skillKeywords = [
                'required', 'must have', 'should have', 'experience with', 'proficient in',
                'knowledge of', 'familiarity with', 'expertise in', 'skills in', 'proficiency in'
            ];
            
            const skills = [];
            const lines = jobDescription.split('\n');
            
            for (const line of lines) {
                for (const keyword of skillKeywords) {
                    if (line.toLowerCase().includes(keyword)) {
                        // Extract skills from this line
                        const skillMatches = line.match(/\b[A-Z][a-zA-Z\s+#&]+(?:\.js|\.net|\.js|\.py|\.java|\.cpp|\.cs|\.php|\.rb|\.go|\.rs|\.swift)\b/g);
                        if (skillMatches) {
                            skills.push(...skillMatches.map(s => s.trim()));
                        }
                    }
                }
            }
            
            return skills;
        }
        
        function extractJobLocation(jobDescription) {
            if (!jobDescription) return null;
            
            const locationPatterns = [
                /\b(location|based in|work from|office in|headquarters in)\s*:?\s*([A-Z][a-zA-Z\s,]+)\b/gi,
                /\b([A-Z][a-zA-Z\s,]+)\s*(?:location|office|headquarters)\b/gi
            ];
            
            for (const pattern of locationPatterns) {
                const match = jobDescription.match(pattern);
                if (match) {
                    return match[1] || match[2];
                }
            }
            
            return null;
        }
        
        function calculateContentQuality(resumeData) {
            let qualityScore = 0;
            
            // Ensure resumeData exists
            if (!resumeData) {
                return 0;
            }
            
            // Check for comprehensive information
            const fields = ['gender', 'location', 'profileStability', 'availability', 'currentCTC', 'expectedCTC'];
            const filledFields = fields.filter(field => resumeData[field] && resumeData[field] !== 'Not Mentioned').length;
            
            qualityScore += (filledFields / fields.length) * 10;
            
            // Bonus for detailed skills
            if (resumeData.keySkills && Array.isArray(resumeData.keySkills) && resumeData.keySkills.length >= 5) {
                qualityScore += 5;
            }
            
            // Bonus for detailed stability analysis
            if (resumeData.profileStability && resumeData.profileStability.includes && resumeData.profileStability.includes('(')) {
                qualityScore += 3;
            }
            
            return Math.min(qualityScore, 10);
        }

        function generateRecommendation(resumeData) {
            const score = resumeData.matchScore;
            
            if (score >= 85) return 'Strong Match - Proceed to Interview';
            if (score >= 75) return 'Good Match - Consider for Next Round';
            if (score >= 65) return 'Moderate Match - Review Further';
            return 'Needs Improvement - Consider for Future';
        }

        // Additional HR Screening Criteria Functions
        function extractEducationLevel(text) {
            const educationPatterns = {
                'PhD/Doctorate': /\b(?:phd|doctorate|doctor|ph\.d|dphil)\b/i,
                'Masters': /\b(?:masters?|ms|m\.s|mba|m\.b\.a|mca|m\.c\.a|mtech|m\.tech|m\.e|me)\b/i,
                'Bachelors': /\b(?:bachelors?|bs|b\.s|btech|b\.tech|b\.e|be|bca|b\.c\.a|bsc|b\.sc|bcom|b\.com)\b/i,
                'Diploma': /\b(?:diploma|polytechnic|iti)\b/i,
                'High School': /\b(?:high school|hsc|12th|intermediate|senior secondary)\b/i
            };
            
            for (const [level, pattern] of Object.entries(educationPatterns)) {
                if (pattern.test(text)) {
                    return level;
                }
            }
            return 'Not Mentioned';
        }

        function extractExperienceYears(text) {
            const experiencePatterns = [
                /\b(\d+(?:\.\d+)?)\s*(?:years?|yrs?)\s*(?:of\s+)?(?:experience|exp|work)\b/i,
                /\b(?:experience|exp|work)\s*(?:of\s+)?(\d+(?:\.\d+)?)\s*(?:years?|yrs?)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:years?|yrs?)\s*(?:in\s+)?(?:industry|field|domain)\b/i
            ];
            
            for (const pattern of experiencePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    const years = parseFloat(match[1]);
                    if (years > 0 && years < 50) {
                        return `${years} years`;
                    }
                }
            }
            return 'Not Mentioned';
        }

        function extractNoticePeriod(text) {
            const noticePatterns = [
                /\b(?:notice period|notice|serving notice)\s*(?:of\s+)?(\d+(?:\.\d+)?)\s*(?:days?|weeks?|months?)\b/i,
                /\b(\d+(?:\.\d+)?)\s*(?:days?|weeks?|months?)\s*(?:notice|notice period)\b/i,
                /\b(?:immediate|ready|available)\s+(?:to\s+)?(?:join|start|relieve)\b/i,
                /\b(?:can\s+)?(?:join|start|relieve)\s+(?:in\s+)?(\d+(?:\.\d+)?)\s*(?:days?|weeks?|months?)\b/i
            ];
            
            for (const pattern of noticePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    const period = parseFloat(match[1]);
                    if (period > 0 && period < 365) {
                        return `${period} days notice`;
                    }
                }
            }
            
            // Check for immediate availability
            if (/\b(?:immediate|ready|available|no notice|serving notice)\b/i.test(text)) {
                return 'Immediate';
            }
            
            return 'Not Mentioned';
        }

        function extractCertifications(text) {
            const certPatterns = [
                /\b(?:certified|certification|certificate)\s+(?:in\s+)?([A-Za-z\s&]+(?:certification|certificate|certified))\b/gi,
                /\b([A-Za-z\s&]+(?:certification|certificate|certified))\b/gi,
                /\b(?:aws|azure|google cloud|microsoft|oracle|cisco|comptia|pmi|scrum|agile)\s+(?:certified|certification)\b/gi
            ];
            
            const certifications = [];
            for (const pattern of certPatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const cert = match[1] || match[0];
                    if (cert && cert.length > 3 && !certifications.includes(cert)) {
                        certifications.push(cert.trim());
                    }
                }
            }
            
            return certifications.length > 0 ? certifications : ['No certifications mentioned'];
        }

        function extractLanguages(text) {
            const languagePatterns = [
                /\b(?:english|hindi|spanish|french|german|chinese|japanese|arabic|russian|portuguese|italian|korean)\b/gi,
                /\b(?:fluent|native|proficient|intermediate|basic)\s+(?:in\s+)?([A-Za-z]+)\b/gi,
                /\b([A-Za-z]+)\s+(?:fluent|native|proficient|intermediate|basic)\b/gi
            ];
            
            const languages = [];
            for (const pattern of languagePatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const lang = match[1] || match[0];
                    if (lang && lang.length > 2 && !languages.includes(lang.toLowerCase())) {
                        languages.push(lang.toLowerCase());
                    }
                }
            }
            
            return languages.length > 0 ? languages : ['Not mentioned'];
        }

        function extractWorkAuthorization(text) {
            const authPatterns = [
                /\b(?:work permit|work visa|green card|citizenship|permanent resident|pr)\b/gi,
                /\b(?:authorized|eligible|legally)\s+(?:to\s+)?(?:work|employment)\b/gi,
                /\b(?:no\s+)?(?:sponsorship|sponsor)\s+(?:required|needed)\b/gi
            ];
            
            for (const pattern of authPatterns) {
                if (pattern.test(text)) {
                    if (/\b(?:no\s+)?(?:sponsorship|sponsor)\s+(?:required|needed)\b/gi.test(text)) {
                        return 'No sponsorship required';
                    }
                    return 'Work authorization available';
                }
            }
            
            return 'Not mentioned';
        }

        function extractRelocationWillingness(text) {
            const relocationPatterns = [
                /\b(?:willing|ready|open|available)\s+(?:to\s+)?(?:relocate|move|travel)\b/gi,
                /\b(?:relocation|relocate|move)\s+(?:willing|ready|open|available)\b/gi,
                /\b(?:remote|work from home|wfh|hybrid|flexible)\s+(?:work|job|position)\b/gi
            ];
            
            for (const pattern of relocationPatterns) {
                if (pattern.test(text)) {
                    if (/\b(?:remote|work from home|wfh)\b/gi.test(text)) {
                        return 'Remote work preferred';
                    }
                    return 'Willing to relocate';
                }
            }
            
            return 'Not mentioned';
        }

        function extractMobileNumber(text) {
            console.log('Extracting mobile number from text:', text.substring(0, 200) + '...');
            
            // Clean and normalize text for better extraction
            const cleanText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = cleanText.split('\n');
            
            // Define what constitutes a valid mobile number context
            const mobileContexts = [
                // Direct mobile/phone labels with numbers
                {
                    patterns: [
                        /(?:mobile|phone|contact|whatsapp|call|dial|mob|tel|cell|ph|mobile\s*no|phone\s*no)\s*:?\s*(\+?91\s*[-]?\s*[6-9]\d{9})/gi,
                        /(?:mobile|phone|contact|whatsapp|call|dial|mob|tel|cell|ph|mobile\s*no|phone\s*no)\s*:?\s*([6-9]\d{9})/gi
                    ],
                    context: 'direct_label'
                },
                // Contact section headers
                {
                    patterns: [
                        /(?:contact|reach|get\s*in\s*touch|communication)\s*:?\s*(\+?91\s*[-]?\s*[6-9]\d{9})/gi,
                        /(?:contact|reach|get\s*in\s*touch|communication)\s*:?\s*([6-9]\d{9})/gi
                    ],
                    context: 'contact_section'
                },
                // Personal information section
                {
                    patterns: [
                        /(?:personal|personal\s*info|personal\s*details|basic\s*info)\s*:?\s*[^\n]*\n\s*(?:mobile|phone|contact|whatsapp|call|dial|mob|tel|cell|ph)\s*:?\s*(\+?91\s*[-]?\s*[6-9]\d{9})/gi,
                        /(?:personal|personal\s*info|personal\s*details|basic\s*info)\s*:?\s*[^\n]*\n\s*(?:mobile|phone|contact|whatsapp|call|dial|mob|tel|cell|ph)\s*:?\s*([6-9]\d{9})/gi
                    ],
                    context: 'personal_section'
                },
                // After email with context
                {
                    patterns: [
                        /(?:email|mail|e-mail)\s*:?\s*[^\n]*\n\s*(?:mobile|phone|contact|whatsapp|call|dial|mob|tel|cell|ph)\s*:?\s*(\+?91\s*[-]?\s*[6-9]\d{9})/gi,
                        /(?:email|mail|e-mail)\s*:?\s*[^\n]*\n\s*(?:mobile|phone|contact|whatsapp|call|dial|mob|tel|cell|ph)\s*:?\s*([6-9]\d{9})/gi
                    ],
                    context: 'after_email'
                }
            ];
            
            // First priority: Extract numbers with clear, direct context
            for (const context of mobileContexts) {
                for (const pattern of context.patterns) {
                    let match;
                    while ((match = pattern.exec(cleanText)) !== null) {
                        const number = match[1].replace(/[\s\-\(\)\[\]\{\}]/g, '');
                        console.log(`Found potential mobile number with ${context.context} context:`, number);
                        
                        if (isValidMobileFormat(number)) {
                            const cleanNumber = formatMobileNumber(number);
                            if (validateMobileNumber(cleanNumber)) {
                                console.log(`✅ Extracted and validated mobile number (${context.context}):`, cleanNumber);
                                return cleanNumber;
                            } else {
                                console.log(`❌ Number failed validation (${context.context}):`, cleanNumber);
                            }
                        }
                    }
                }
            }
            
            // Second priority: Smart context-based extraction
            const smartExtraction = extractMobileWithSmartContext(lines);
            if (smartExtraction) {
                return smartExtraction;
            }
            
            // Third priority: Look for numbers in structured sections
            const structuredExtraction = extractMobileFromStructuredSections(lines);
            if (structuredExtraction) {
                return structuredExtraction;
            }
            
            console.log('❌ No valid mobile number found with proper context');
            return null;
        }

        function isValidMobileFormat(number) {
            // Basic format validation
            if (number.length < 10 || number.length > 15) return false;
            
            // Must start with valid patterns
            if (number.startsWith('+91')) {
                return number.length === 13 && /^\+91[6-9]\d{9}$/.test(number);
            } else if (number.startsWith('91')) {
                return number.length === 12 && /^91[6-9]\d{9}$/.test(number);
            } else if (number.length === 10) {
                return /^[6-9]\d{9}$/.test(number);
            }
            
            return false;
        }

        function formatMobileNumber(number) {
            let cleanNumber = number.replace(/[\s\-\(\)\[\]\{\}]/g, '');
            
            if (cleanNumber.startsWith('91') && cleanNumber.length === 12) {
                cleanNumber = '+' + cleanNumber;
            } else if (cleanNumber.length === 10 && /^[6-9]/.test(cleanNumber)) {
                cleanNumber = '+91' + cleanNumber;
            }
            
            return cleanNumber;
        }

        function extractMobileWithSmartContext(lines) {
            const contactKeywords = ['mobile', 'phone', 'contact', 'whatsapp', 'call', 'dial', 'mob', 'tel', 'cell', 'ph'];
            const sectionHeaders = ['contact', 'personal', 'basic', 'info', 'details', 'reach'];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase().trim();
                const nextLine = lines[i + 1] || '';
                const prevLine = lines[i - 1] || '';
                
                // Check if this line is a section header
                const isSectionHeader = sectionHeaders.some(header => 
                    line.includes(header) && (line.endsWith(':') || line.endsWith('details') || line.endsWith('info'))
                );
                
                // Check if current line has contact keywords
                const hasContactKeyword = contactKeywords.some(keyword => line.includes(keyword));
                
                if (hasContactKeyword || isSectionHeader) {
                    // Look for mobile number in current line, next line, or previous line
                    const numberPattern = /(\+?91\s*[-]?\s*[6-9]\d{9})|([6-9]\d{9})/gi;
                    
                    // Check current line
                    let match = numberPattern.exec(lines[i]);
                    if (match) {
                        const number = (match[1] || match[2]);
                        if (isValidMobileFormat(number)) {
                            const cleanNumber = formatMobileNumber(number);
                            if (validateMobileNumber(cleanNumber)) {
                                console.log('✅ Found mobile number with smart context (current line):', cleanNumber);
                                return cleanNumber;
                            }
                        }
                    }
                    
                    // Check next line
                    match = numberPattern.exec(nextLine);
                    if (match) {
                        const number = (match[1] || match[2]);
                        if (isValidMobileFormat(number)) {
                            const cleanNumber = formatMobileNumber(number);
                            if (validateMobileNumber(cleanNumber)) {
                                console.log('✅ Found mobile number with smart context (next line):', cleanNumber);
                                return cleanNumber;
                            }
                        }
                    }
                }
            }
            
            return null;
        }

        function extractMobileFromStructuredSections(lines) {
            // Look for common resume structure patterns
            const structurePatterns = [
                {
                    start: /^(?:contact|reach|get\s*in\s*touch|communication)\s*:?$/i,
                    end: /^(?:education|experience|skills|projects|achievements|certifications)\s*:?$/i,
                    name: 'contact_section'
                },
                {
                    start: /^(?:personal|personal\s*info|personal\s*details|basic\s*info)\s*:?$/i,
                    end: /^(?:education|experience|skills|projects|achievements|certifications|contact)\s*:?$/i,
                    name: 'personal_section'
                }
            ];
            
            for (const pattern of structurePatterns) {
                let inSection = false;
                let sectionLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (pattern.start.test(line)) {
                        inSection = true;
                        sectionLines = [];
                        continue;
                    }
                    
                    if (inSection && pattern.end.test(line)) {
                        inSection = false;
                        // Process the section we just collected
                        const mobileNumber = findMobileInSection(sectionLines, pattern.name);
                        if (mobileNumber) {
                            return mobileNumber;
                        }
                        sectionLines = [];
                        continue;
                    }
                    
                    if (inSection) {
                        sectionLines.push(line);
                    }
                }
                
                // Check if we're still in a section at the end
                if (inSection && sectionLines.length > 0) {
                    const mobileNumber = findMobileInSection(sectionLines, pattern.name);
                    if (mobileNumber) {
                        return mobileNumber;
                    }
                }
            }
            
            return null;
        }

        function findMobileInSection(sectionLines, sectionName) {
            const contactKeywords = ['mobile', 'phone', 'contact', 'whatsapp', 'call', 'dial', 'mob', 'tel', 'cell', 'ph'];
            const numberPattern = /(\+?91\s*[-]?\s*[6-9]\d{9})|([6-9]\d{9})/gi;
            
            for (const line of sectionLines) {
                const hasContactKeyword = contactKeywords.some(keyword => 
                    line.toLowerCase().includes(keyword)
                );
                
                if (hasContactKeyword) {
                    let match = numberPattern.exec(line);
                    if (match) {
                        const number = (match[1] || match[2]);
                        if (isValidMobileFormat(number)) {
                            const cleanNumber = formatMobileNumber(number);
                            if (validateMobileNumber(cleanNumber)) {
                                console.log(`✅ Found mobile number in ${sectionName} section:`, cleanNumber);
                                return cleanNumber;
                            }
                        }
                    }
                }
            }
            
            return null;
        }

        function validateMobileNumber(number) {
            // Remove all non-digit characters except +
            const cleanNumber = number.replace(/[^\d+]/g, '');
            
            // Additional validation: Check for common invalid patterns
            if (cleanNumber.includes('000000') || cleanNumber.includes('111111') || 
                cleanNumber.includes('222222') || cleanNumber.includes('333333') ||
                cleanNumber.includes('444444') || cleanNumber.includes('555555') ||
                cleanNumber.includes('666666') || cleanNumber.includes('777777') ||
                cleanNumber.includes('888888') || cleanNumber.includes('999999')) {
                console.log('❌ Number contains repeated digits pattern:', cleanNumber);
                return false;
            }
            
            // Check if it's a valid Indian mobile number
            if (cleanNumber.startsWith('+91')) {
                const mobilePart = cleanNumber.substring(3);
                if (mobilePart.length === 10 && /^[6-9]/.test(mobilePart)) {
                    // Additional validation: Check for realistic mobile number patterns
                    if (isRealisticMobileNumber(mobilePart)) {
                        return true;
                    }
                }
            } else if (cleanNumber.startsWith('91') && cleanNumber.length === 12) {
                const mobilePart = cleanNumber.substring(2);
                if (/^[6-9]/.test(mobilePart)) {
                    if (isRealisticMobileNumber(mobilePart)) {
                        return true;
                    }
                }
            } else if (cleanNumber.length === 10 && /^[6-9]/.test(cleanNumber)) {
                if (isRealisticMobileNumber(cleanNumber)) {
                    return true;
                }
            }
            
            return false;
        }

        function isRealisticMobileNumber(number) {
            // Check for common invalid patterns in Indian mobile numbers
            const invalidPatterns = [
                /^[6-9]0{8}$/,           // All zeros after first digit
                /^[6-9]1{8}$/,           // All ones after first digit
                /^[6-9]2{8}$/,           // All twos after first digit
                /^[6-9]3{8}$/,           // All threes after first digit
                /^[6-9]4{8}$/,           // All fours after first digit
                /^[6-9]5{8}$/,           // All fives after first digit
                /^[6-9]6{8}$/,           // All sixes after first digit
                /^[6-9]7{8}$/,           // All sevens after first digit
                /^[6-9]8{8}$/,           // All eights after first digit
                /^[6-9]9{8}$/,           // All nines after first digit
                /^[6-9](\d)\1{7}$/,      // Same digit repeated 8 times after first digit
                /^[6-9](\d{2})\1{3}$/,   // Same 2-digit pattern repeated 4 times
                /^[6-9](\d{4})\1$/,      // Same 4-digit pattern repeated twice
                /^[6-9]12345678$/,        // Sequential pattern
                /^[6-9]87654321$/,        // Reverse sequential pattern
                /^[6-9]11111111$/,        // All ones
                /^[6-9]00000000$/         // All zeros
            ];
            
            for (const pattern of invalidPatterns) {
                if (pattern.test(number)) {
                    console.log('❌ Number matches invalid pattern:', pattern.source, number);
                    return false;
                }
            }
            
            // Check for too many consecutive same digits
            let maxConsecutive = 1;
            let currentConsecutive = 1;
            for (let i = 1; i < number.length; i++) {
                if (number[i] === number[i-1]) {
                    currentConsecutive++;
                    maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                } else {
                    currentConsecutive = 1;
                }
            }
            
            if (maxConsecutive > 6) {
                console.log('❌ Too many consecutive same digits:', maxConsecutive, number);
                return false;
            }
            
            return true;
        }

        function generateWhatsAppMessage(candidate) {
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let message = `*INTERVIEW INVITATION* 📋\n\n`;
            message += `Hello ${candidate.name}! 👋\n\n`;
            message += `Thank you for your interest in our company. We have reviewed your resume and would like to invite you for an interview.\n\n`;
            
            message += `*📊 CANDIDATE PROFILE:*\n`;
            message += `• Match Score: ${Math.round(candidate.matchScore)}%\n`;
            if (candidate.experienceYears && candidate.experienceYears !== 'Not Mentioned') {
                message += `• Experience: ${candidate.experienceYears}\n`;
            }
            if (candidate.location && candidate.location !== 'Not Mentioned') {
                message += `• Location: ${candidate.location}\n`;
            }
            if (candidate.keySkills && candidate.keySkills.length > 0) {
                message += `• Top Skills: ${candidate.keySkills.slice(0, 3).join(', ')}\n`;
            }
            message += `\n`;
            
            message += `*📅 INTERVIEW OPTIONS:*\n`;
            message += `We can schedule:\n`;
            message += `• Video Call (Zoom/Teams)\n`;
            message += `• Phone Interview\n`;
            message += `• In-person (if location permits)\n\n`;
            
            message += `*⏰ AVAILABILITY:*\n`;
            if (candidate.noticePeriod && candidate.noticePeriod !== 'Not Mentioned') {
                message += `• Notice Period: ${candidate.noticePeriod}\n`;
            } else {
                message += `• Notice Period: To be discussed\n`;
            }
            message += `• Expected Joining: Based on your availability\n\n`;
            
            message += `*💰 COMPENSATION:*\n`;
            if (candidate.currentCTC !== 'Not Mentioned') {
                message += `• Current CTC: ${candidate.currentCTC}\n`;
            }
            if (candidate.expectedCTC !== 'Not Mentioned') {
                message += `• Expected CTC: ${candidate.expectedCTC}\n`;
            }
            message += `• Package: Negotiable based on experience\n\n`;
            
            message += `*📝 NEXT STEPS:*\n`;
            message += `Please reply with:\n`;
            message += `1. Your preferred interview date & time\n`;
            message += `2. Preferred interview mode\n`;
            message += `3. Any questions you may have\n\n`;
            
            message += `*🏢 COMPANY DETAILS:*\n`;
            message += `• Industry: Technology/IT\n`;
            message += `• Work Mode: Hybrid/Remote options available\n`;
            message += `• Growth: Excellent career progression opportunities\n\n`;
            
            message += `We look forward to meeting you!\n\n`;
            message += `Best regards,\n*HR Team*\n${currentDate}`;
            
            return encodeURIComponent(message);
        }

        function sendWhatsAppInvite(candidateName) {
            console.log('Sending WhatsApp invite to:', candidateName);
            
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            console.log('Candidate found:', candidate);
            console.log('Mobile number:', candidate.mobileNumber);
            
            const mobileNumber = candidate.mobileNumber;
            if (!mobileNumber) {
                alert('No mobile number found for this candidate. Please check the resume for contact information.');
                return;
            }
            
            // Generate personalized message
            const message = generateWhatsAppMessage(candidate);
            console.log('Generated message:', message);
            
            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/${mobileNumber}?text=${message}`;
            console.log('WhatsApp URL:', whatsappUrl);
            
            // Open WhatsApp in new tab
            window.open(whatsappUrl, '_blank');
            
            // Show confirmation
            alert(`WhatsApp invite prepared for ${candidate.name} (${mobileNumber})\n\nPlease check the new tab to send the message.`);
        }

        // Debug function to test mobile number extraction
        function testMobileExtraction() {
            const testCases = [
                {
                    name: 'Valid mobile with context',
                    text: `
                        Name: John Doe
                        Email: john@example.com
                        Mobile: +91 98765 43210
                        Phone: 87654 32109
                    `,
                    expected: '+919876543210'
                },
                {
                    name: 'Mobile in contact section',
                    text: `
                        Contact:
                        Mobile: 87654 32109
                        Email: john@example.com
                    `,
                    expected: '+918765432109'
                },
                {
                    name: 'Personal details section',
                    text: `
                        Personal Details:
                        Mobile No: 76543 21098
                        Location: Mumbai
                    `,
                    expected: '+917654321098'
                },
                {
                    name: 'Invalid patterns (should reject)',
                    text: `
                        Mobile: 6000000000
                        Phone: 7111111111
                        Contact: 8222222222
                    `,
                    expected: null
                },
                {
                    name: 'Mixed valid and invalid',
                    text: `
                        Mobile: 98765 43210
                        Phone: 6000000000
                        Contact: 87654 32109
                    `,
                    expected: '+919876543210'
                }
            ];
            
            console.log('🧪 Testing mobile extraction with multiple test cases...');
            
            for (const testCase of testCases) {
                console.log(`\n--- Testing: ${testCase.name} ---`);
                const extracted = extractMobileNumber(testCase.text);
                const isValid = extracted ? validateMobileNumber(extracted) : false;
                
                console.log(`Expected: ${testCase.expected}`);
                console.log(`Extracted: ${extracted}`);
                console.log(`Valid: ${isValid}`);
                
                if (extracted === testCase.expected) {
                    console.log('✅ PASS');
                } else if (testCase.expected === null && extracted === null) {
                    console.log('✅ PASS (correctly rejected)');
                } else {
                    console.log('❌ FAIL');
                }
            }
            
            // Test with the first valid case
            const firstValidCase = testCases.find(tc => tc.expected !== null);
            if (firstValidCase) {
                const extracted = extractMobileNumber(firstValidCase.text);
                if (extracted) {
                    const isValid = validateMobileNumber(extracted);
                    alert(`Test completed!\n\nExtracted: ${extracted}\nValidation: ${isValid ? 'Valid' : 'Invalid'}\n\nCheck console for detailed results.`);
                } else {
                    alert('Test completed but no mobile number found.\n\nCheck console for detailed results.');
                }
            }
        }

        // Smart action functions
        function exportCandidateData(candidateName) {
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            // Clean up job description for export
            let cleanJobDescription = 'Not available';
            if (window.currentJobDescription) {
                // If it's a long PDF content, truncate and clean it
                if (window.currentJobDescription.length > 500) {
                    cleanJobDescription = window.currentJobDescription
                        .substring(0, 500)
                        .replace(/[^\x20-\x7E\n]/g, ' ') // Remove non-printable characters
                        .replace(/\s+/g, ' ') // Normalize whitespace
                        .trim() + '... (truncated)';
                } else {
                    cleanJobDescription = window.currentJobDescription;
                }
            }
            
            // Create well-formatted text content
            const textContent = `CANDIDATE RESUME ANALYSIS REPORT
${'='.repeat(60)}

EXPORT DATE: ${new Date().toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
})}

CANDIDATE INFORMATION
${'-'.repeat(30)}
Name: ${candidate.name}
File: ${candidate.fileName}
Match Score: ${Math.round(candidate.matchScore)}%
${candidate.mobileNumber ? `Contact: ${candidate.mobileNumber}` : 'Contact: Not available'}

PERSONAL DETAILS
${'-'.repeat(30)}
Location: ${candidate.location}
Availability: ${candidate.availability}

EDUCATION & EXPERIENCE
${'-'.repeat(30)}
Education Level: ${candidate.educationLevel || 'Not Mentioned'}
Total Experience: ${candidate.experienceYears || 'Not Mentioned'}
Notice Period: ${candidate.noticePeriod || 'Not Mentioned'}

PROFESSIONAL ASSESSMENT
${'-'.repeat(30)}
Profile Stability: ${candidate.profileStability}

KEY SKILLS
${'-'.repeat(30)}
${candidate.keySkills && candidate.keySkills.length > 0 
    ? candidate.keySkills.map(skill => `• ${skill}`).join('\n')
    : 'No skills information available'}

CERTIFICATIONS
${'-'.repeat(30)}
${candidate.certifications && candidate.certifications.length > 0 
    ? candidate.certifications.map(cert => `• ${cert}`).join('\n')
    : 'No certifications mentioned'}

LANGUAGES
${'-'.repeat(30)}
${candidate.languages && candidate.languages.length > 0 
    ? candidate.languages.map(lang => `• ${lang}`).join('\n')
    : 'Not mentioned'}

WORK AUTHORIZATION & RELOCATION
${'-'.repeat(30)}
Work Authorization: ${candidate.workAuthorization || 'Not mentioned'}
Relocation: ${candidate.relocationWillingness || 'Not mentioned'}

COMPENSATION DETAILS
${'-'.repeat(30)}
Current CTC: ${candidate.currentCTC}
Expected CTC: ${candidate.expectedCTC}

AREAS OF CONCERN
${'-'.repeat(30)}
${candidate.concerns && candidate.concerns.length > 0 
    ? candidate.concerns.map(concern => `• ${concern}`).join('\n')
    : 'No concerns identified'}

RECRUITER'S RECOMMENDATION
${'-'.repeat(30)}
${candidate.recommendation}

JOB DESCRIPTION REFERENCE
${'-'.repeat(30)}
${cleanJobDescription}

${'='.repeat(60)}
Report generated by IKF HR Candidate Screening Platform
This analysis is based on AI-powered resume screening technology.`;
            
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${candidateName}_resume_analysis.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Exported ${candidateName}'s data successfully as text file!`);
        }
        
        function scheduleInterview(candidateName) {
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            const interviewDate = prompt(`Schedule interview for ${candidateName} (Enter date in DD/MM/YYYY format):`);
            if (interviewDate) {
                // Here you would integrate with your calendar system
                alert(`Interview scheduled for ${candidateName} on ${interviewDate}`);
                
                // Add to interview schedule
                if (!window.interviewSchedule) window.interviewSchedule = [];
                window.interviewSchedule.push({
                    candidate: candidateName,
                    date: interviewDate,
                    status: 'Scheduled',
                    matchScore: candidate.matchScore
                });
            }
        }
        
        function addToShortlist(candidateName) {
            const candidate = window.currentResults?.find(c => c.name === candidateName);
            if (!candidate) {
                alert('Candidate data not found');
                return;
            }
            
            if (!window.shortlistedCandidates) window.shortlistedCandidates = [];
            
            const existingIndex = window.shortlistedCandidates.findIndex(c => c.name === candidateName);
            if (existingIndex >= 0) {
                window.shortlistedCandidates.splice(existingIndex, 1);
                alert(`${candidateName} removed from shortlist`);
            } else {
                window.shortlistedCandidates.push({
                    ...candidate,
                    shortlistedDate: new Date().toISOString()
                });
                alert(`${candidateName} added to shortlist!`);
            }
            
            updateShortlistDisplay();
        }
        
        function updateShortlistDisplay() {
            if (!window.shortlistedCandidates || window.shortlistedCandidates.length === 0) return;
            
            // Create or update shortlist display
            let shortlistDiv = document.getElementById('shortlistSection');
            if (!shortlistDiv) {
                shortlistDiv = document.createElement('div');
                shortlistDiv.id = 'shortlistSection';
                shortlistDiv.style.cssText = 'background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; margin: 20px 0;';
                document.getElementById('resultsContent').insertBefore(shortlistDiv, document.getElementById('resultsContent').firstChild);
            }
            
            shortlistDiv.innerHTML = `
                <h3 style="color: #38a169; margin-bottom: 15px;">
                    <i class="fas fa-star"></i> Shortlisted Candidates (${window.shortlistedCandidates.length})
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${window.shortlistedCandidates.map(candidate => `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #c6f6d5;">
                            <div style="font-weight: bold; color: #2d3748;">${candidate.name}</div>
                            <div style="font-size: 0.9rem; color: #718096;">Match: ${Math.round(candidate.matchScore)}%</div>
                            <div style="font-size: 0.9rem; color: #718096;">Shortlisted: ${new Date(candidate.shortlistedDate).toLocaleDateString()}</div>
                            <button onclick="removeFromShortlist('${candidate.name}')" style="background: #f56565; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-top: 8px;">
                                Remove
                            </button>
                        </div>
                    `).join('')}
                        </div>
                    `;
        }
        
        function removeFromShortlist(candidateName) {
            if (window.shortlistedCandidates) {
                window.shortlistedCandidates = window.shortlistedCandidates.filter(c => c.name !== candidateName);
                updateShortlistDisplay();
            }
        }
        
        function filterCandidates() {
            if (!window.currentResults) return;
            
            const searchTerm = document.getElementById('candidateSearch').value.toLowerCase();
            const scoreFilter = document.getElementById('scoreFilter').value;
            const locationFilter = document.getElementById('locationFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            
            let filteredResults = window.currentResults.filter(candidate => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    candidate.name.toLowerCase().includes(searchTerm) ||
                    candidate.keySkills.some(skill => skill.toLowerCase().includes(searchTerm)) ||
                    candidate.location.toLowerCase().includes(searchTerm);
                
                // Score filter
                const matchesScore = !scoreFilter || candidate.matchScore >= parseInt(scoreFilter);
                
                // Location filter
                const matchesLocation = !locationFilter || candidate.location === locationFilter;
                
                return matchesSearch && matchesScore && matchesLocation;
            });
            
            // Sort results
            switch (sortBy) {
                case 'name':
                    filteredResults.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'experience':
                    filteredResults.sort((a, b) => {
                        const aExp = parseFloat(a.profileStability.match(/(\d+\.?\d*)/)?.[1] || 0);
                        const bExp = parseFloat(b.profileStability.match(/(\d+\.?\d*)/)?.[1] || 0);
                        return bExp - aExp;
                    });
                    break;
                default: // score
                    filteredResults.sort((a, b) => b.matchScore - a.matchScore);
            }
            
            // Update display with filtered results
            displayFilteredResults(filteredResults);
        }
        
        function displayFilteredResults(filteredResults) {
            const content = document.getElementById('resultsContent');
            
            // Keep the header and filters, update only the candidate sections
            const headerSection = content.querySelector('h2').parentNode;
            const filtersSection = content.querySelector('#candidateSearch').closest('div').parentNode;
            
            // Clear existing candidate sections
            const existingSections = content.querySelectorAll('h3[style*="margin: 30px 0 20px 0"]');
            existingSections.forEach(section => section.remove());
            
            // Categorize filtered candidates
            const strongCandidates = filteredResults.filter(c => c.matchScore >= 80);
            const goodCandidates = filteredResults.filter(c => c.matchScore >= 70 && c.matchScore < 80);
            const moderateCandidates = filteredResults.filter(c => c.matchScore >= 60 && c.matchScore < 70);
            const weakCandidates = filteredResults.filter(c => c.matchScore < 60);
            
            let candidatesHtml = '';
            
            if (strongCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #38a169; margin: 30px 0 20px 0; text-align: center;">🚀 Strong Matches (${strongCandidates.length})</h3>`;
                strongCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            if (goodCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #dd6b20; margin: 30px 0 20px 0; text-align: center;">✅ Good Matches (${goodCandidates.length})</h3>`;
                goodCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            if (moderateCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #d69e2e; margin: 30px 0 20px 0; text-align: center;">🟡 Moderate Matches (${moderateCandidates.length})</h3>`;
                moderateCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            if (weakCandidates.length > 0) {
                candidatesHtml += `<h3 style="color: #e53e3e; margin: 30px 0 20px 0; text-align: center;">⚠️ Candidates Needing Review (${weakCandidates.length})</h3>`;
                weakCandidates.forEach(candidate => {
                    candidatesHtml += createCandidateCard(candidate);
                });
            }
            
            // Insert candidates after filters
            filtersSection.insertAdjacentHTML('afterend', candidatesHtml);
            
            // Update shortlist if it exists
            if (window.shortlistedCandidates && window.shortlistedCandidates.length > 0) {
                updateShortlistDisplay();
            }
        }
        
        // Initialize file handlers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, file handlers initialized');
            
            // Initialize global variables
            window.currentResults = null;
            window.currentJobDescription = localStorage.getItem('currentJobDescription') || null;
            window.shortlistedCandidates = [];
            window.interviewSchedule = [];
            
            // Load saved job descriptions
            loadSavedJobDescriptions();
            
            // If there's a saved job description, show it
            if (window.currentJobDescription) {
                displaySavedJobDescription();
            }
        });

        // Job Description Storage Functions
        function saveJobDescription(jobDescription, fileName = 'Job Description') {
            const jobData = {
                id: Date.now(),
                content: jobDescription,
                fileName: fileName,
                date: new Date().toISOString(),
                usageCount: 1
            };
            
            // Check if this job description already exists
            const existingIndex = savedJobDescriptions.findIndex(job => 
                job.content === jobDescription
            );
            
            if (existingIndex !== -1) {
                // Update existing entry
                savedJobDescriptions[existingIndex].usageCount++;
                savedJobDescriptions[existingIndex].lastUsed = new Date().toISOString();
            } else {
                // Add new entry
                savedJobDescriptions.push(jobData);
            }
            
            // Store in localStorage
            localStorage.setItem('savedJobDescriptions', JSON.stringify(savedJobDescriptions));
            localStorage.setItem('currentJobDescription', jobDescription);
            
            // Update global variable
            window.currentJobDescription = jobDescription;
            
            console.log('Job description saved:', jobData);
        }

        function loadSavedJobDescriptions() {
            const saved = localStorage.getItem('savedJobDescriptions');
            if (saved) {
                savedJobDescriptions = JSON.parse(saved);
                console.log('Loaded saved job descriptions:', savedJobDescriptions);
            }
        }

        function displaySavedJobDescriptions() {
            const container = document.getElementById('savedJobDescriptions');
            if (!container) return;
            
            if (savedJobDescriptions.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; font-style: italic;">No saved job descriptions yet</p>';
                return;
            }
            
            let html = '<h4 style="color: #4a5568; margin-bottom: 15px;">📋 Saved Job Descriptions</h4>';
            
            savedJobDescriptions.forEach(job => {
                const isCurrent = job.content === window.currentJobDescription;
                const shortContent = job.content.substring(0, 100) + (job.content.length > 100 ? '...' : '');
                
                html += `
                    <div style="background: ${isCurrent ? '#f0fff4' : '#f7fafc'}; border: 1px solid ${isCurrent ? '#48bb78' : '#e2e8f0'}; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #2d3748;">${job.fileName}</strong>
                                <div style="color: #718096; font-size: 0.9rem; margin-top: 2px;">
                                    Used ${job.usageCount} time${job.usageCount > 1 ? 's' : ''} • ${new Date(job.date).toLocaleDateString()}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${isCurrent ? '<span style="background: #48bb78; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">Current</span>' : ''}
                                <button onclick="useJobDescription('${job.id}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                    ${isCurrent ? '✓ Active' : 'Use'}
                                </button>
                                <button onclick="deleteJobDescription('${job.id}')" style="background: #e53e3e; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div style="color: #4a5568; font-size: 0.9rem; line-height: 1.4;">
                            ${shortContent}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function useJobDescription(jobId) {
            const job = savedJobDescriptions.find(j => j.id === parseInt(jobId));
            if (job) {
                window.currentJobDescription = job.content;
                localStorage.setItem('currentJobDescription', job.content);
                
                // Update usage count
                job.usageCount++;
                job.lastUsed = new Date().toISOString();
                localStorage.setItem('savedJobDescriptions', JSON.stringify(savedJobDescriptions));
                
                // Update display
                displaySavedJobDescriptions();
                displaySavedJobDescription();
                
                alert(`Using job description: ${job.fileName}`);
            }
        }

        function deleteJobDescription(jobId) {
            if (confirm('Are you sure you want to delete this job description?')) {
                const index = savedJobDescriptions.findIndex(j => j.id === parseInt(jobId));
                if (index !== -1) {
                    const deletedJob = savedJobDescriptions[index];
                    savedJobDescriptions.splice(index, 1);
                    localStorage.setItem('savedJobDescriptions', JSON.stringify(savedJobDescriptions));
                    
                    // If this was the current job description, clear it
                    if (deletedJob.content === window.currentJobDescription) {
                        window.currentJobDescription = null;
                        localStorage.removeItem('currentJobDescription');
                        hideSavedJobDescription();
                    }
                    
                    displaySavedJobDescriptions();
                    alert('Job description deleted successfully');
                }
            }
        }

        function displaySavedJobDescription() {
            if (!window.currentJobDescription) return;
            
            const container = document.getElementById('currentJobDescription');
            if (!container) return;
            
            const shortContent = window.currentJobDescription.substring(0, 200) + (window.currentJobDescription.length > 200 ? '...' : '');
            
            container.innerHTML = `
                <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #38a169; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-file-alt"></i> Current Job Description
                        <button onclick="clearCurrentJobDescription()" style="background: #e53e3e; color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-left: auto;">
                            Clear
                        </button>
                    </h4>
                    <div style="color: #2d3748; line-height: 1.6; margin-bottom: 15px;">
                        ${shortContent}
                    </div>
                    <button onclick="showFullJobDescription()" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        View Full Description
                    </button>
                </div>
            `;
        }

        function hideSavedJobDescription() {
            const container = document.getElementById('currentJobDescription');
            if (container) {
                container.innerHTML = '';
            }
        }

        function clearCurrentJobDescription() {
            if (confirm('Are you sure you want to clear the current job description?')) {
                window.currentJobDescription = null;
                localStorage.removeItem('currentJobDescription');
                hideSavedJobDescription();
                alert('Current job description cleared');
            }
        }

        function showFullJobDescription() {
            if (window.currentJobDescription) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center; padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2d3748;">Full Job Description</h3>
                            <button onclick="this.closest('.modal').remove()" style="background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                        <div style="color: #2d3748; line-height: 1.6; white-space: pre-wrap;">
                            ${window.currentJobDescription}
                        </div>
                    </div>
                `;
                
                modal.className = 'modal';
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }
        }
    </script>
</body>
</html>
